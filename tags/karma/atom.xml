<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: karma | Blues 小站]]></title>
  <link href="http://www.shenyanchao.cn/tags/karma/atom.xml" rel="self"/>
  <link href="http://www.shenyanchao.cn/"/>
  <updated>2013-09-11T18:00:59+08:00</updated>
  <id>http://www.shenyanchao.cn/</id>
  <author>
    <name><![CDATA[ShenYanchao]]></name>
    <email><![CDATA[zhiyi.shen@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Karma与Jenkins-CI集成]]></title>
    <link href="http://www.shenyanchao.cn/blog/2013/04/01/run-karma-in-jenkins-ci/"/>
    <updated>2013-04-01T19:38:00+08:00</updated>
    <id>http://www.shenyanchao.cn/blog/2013/04/01/run-karma-in-jenkins-ci</id>
    <content type="html"><![CDATA[<p>Jenkins是一款目前最为流行的持续集成工具，那么，如何让Karma的能集成到Jenkins，并自动执行呢？</p>

<h3>前提条件</h3>

<p>Jenkins Server上（可以是Master，也许是Slave结点，总之在那个Server上跑，就需要安装），安装：</p>

<ul>
<li>Node</li>
<li>Karma</li>
</ul>


<h3>配置Karma.conf.js文件</h3>

<p>必须保证：</p>

<pre><code>singleRun = true;
</code></pre>

<p>只有这样，才能保证运行Test后，浏览器自动退出，不影响下次执行。  <br/>
在Jenkins中，也许你想查看测试结果，这个时候可以借助junit reporter。</p>

<pre><code>reporters = ['junit'];
junitReporter = {
    outputFile: 'test-results.xml'
};
</code></pre>

<p>那么，Junit格式的测试结果就存到了test-results.xml中。</p>

<p>另外一种情况，我可能还想查看一下代码覆盖率。Karma也是支持的，要进行以下的配置：</p>

<pre><code>reporters = ['coverage'];

preprocessors = {
    'src/*.js': 'coverage'
};

coverageReporter = {
    type : 'cobertura',
    dir : 'coverage/'
};
</code></pre>

<p>这里，reporters指出了要生成coverage报告。preprocessors指明了要统计覆盖率的源码。coverageReporter里，指明type为cobertura，dir则是报告路径。type用多种选择，其中cobertura为Jenkins专属的。</p>

<!--more-->


<h3>一个Jenkins Job</h3>

<p>1.新建一个自由风格（freestyle）的Job即可。 <br/>
2.Restrict where this project can be run 里面填好前提条件中的机器名。当然如果直接是在Master结点，这个可以忽略。 <br/>
3.源码管理部分，填写repository url。  <br/>
4.在构建里，直接填写<code>karma start</code>即可。 <br/>
5.在构建后操作里。选择Publish Cobertura Coverage Report,并指定生成的XML地址。如下图：</p>

<p><img src="/images/blog/karma-jenkins-cobertura.png" alt="karma-jenkins-cobertura" /></p>

<p>6.在构建后操作里。选择Publish JUnit test result report,同样指定report的XML路径。如图：</p>

<p><img src="/images/blog/karma-jenkins-junit.png" alt="karma-jenkins-junit" /></p>

<h3>Jenkins运行结果</h3>

<p>Code Coverage结果： <br/>
<img src="/images/blog/karma-jenkins-codecoverage.png" alt="" /></p>

<p>点击进入后，可以看到具体的覆盖率情况： <br/>
<img src="/images/blog/karma-jenkins-codecoverage-detail.png" alt="" /></p>

<p>JUnit结果： <br/>
<img src="/images/blog/karma-jenkins-junit-report.png" alt="" /></p>

<p>点进去后可以查看详细信息：<br/>
<img src="/images/blog/karma-jenkins-junit-report-detail.png" alt="" /></p>

<h3>关于Coverage</h3>

<p>coverageReporter的类型有以下几种：</p>

<ul>
<li>html (default)</li>
<li>lcov (lcov and html)</li>
<li>lcovonly</li>
<li>text (standard output)</li>
<li>text-summary (standard output)</li>
<li>cobertura (xml format supported by Jenkins)</li>
</ul>


<p>Karma是使用<a href="http://gotwarlost.github.com/istanbul/">istanbul</a>来生成报告的，上面在Jenkins种使用的cobertura类型。如果不在CI环境中，那么可以考虑使用lcon或者html类型，report也是相当好看呢。 <br/>
以下是lcov类型的Coverage结果：</p>

<p><img src="/images/blog/karma-lcov-1.png" alt="" /></p>

<p>而下面的结果，则指明了哪行源码被覆盖了。 <br/>
<img src="/images/blog/karma-lcov-2.png" alt="" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用Karma来驱动mocha测试]]></title>
    <link href="http://www.shenyanchao.cn/blog/2013/03/27/use-karma-to-run-mocha-test/"/>
    <updated>2013-03-27T19:00:00+08:00</updated>
    <id>http://www.shenyanchao.cn/blog/2013/03/27/use-karma-to-run-mocha-test</id>
    <content type="html"><![CDATA[<h2>从Testacular到Karma的变化</h2>

<p>2013年03月18日，Testacular正式被重命名为Karma。具体原因，讲起来缺也很滑稽。这里面不含有任何的商业成分，只是因为Testacular与Testicular很相似，因此令人感觉尴尬。仅仅此而已，谁让JsTestDriver已经被别人给拿走了。<br/>
安装：</p>

<pre><code>npm install -g karma
</code></pre>

<h2>什么时候使用Karma？</h2>

<ul>
<li>在真实浏览器里测试。</li>
<li>在多种浏览器里进行测试（包括桌面、移动）。</li>
<li>在本地开发环境执行测试。</li>
<li>想在持续集成CI内运行测试。</li>
<li>想在每次保存代码时，自动执行测试。</li>
<li>热衷于terminal小黑屏。</li>
<li>不想陷入令人厌烦的测试生活。</li>
<li>想使用Istanbul自动生成coverage报告。</li>
<li>想在源码中使用RequireJS。</li>
</ul>


<h2>Karma不是Testing Framework</h2>

<p>Karma自从出现，就是一直作为一个Test Runner而存在的，只是用来驱动测试的框架。不过到目前为止，它支持以下流行的测试框架。</p>

<ul>
<li>Mocha</li>
<li>Jasmine</li>
<li>QUnit</li>
</ul>


<!--more-->


<h2>Karma与Test Framework集成</h2>

<p>Karma对各种Test Framework的支持是以插件的模式进行支持的。<br/>
只需要在karma.conf.js进行以下配置（mocha为例）：</p>

<pre><code>frameworks = ['mocha'];

plugins = [
'karma-mocha'
];
</code></pre>

<p>在此处只是配置了一下，具体支持的plugin要在当前目录下进行安装：</p>

<pre><code>npm install karma-mocha
</code></pre>

<p>其他框架依此类推。</p>

<h2>Karma报告</h2>

<p>Karma的报告（reporter）也是以插件模式进行的。</p>

<h4>JUnit Reporter</h4>

<p>首先，要定义reporter类型，在karma.conf.js添加：</p>

<pre><code>reporters = ['junit'];
</code></pre>

<p>如果想更近一步的话，可以配置一下报告的位置。</p>

<pre><code>junitReporter = {
    outputFile: 'junit-report/test-results.xml'
};
</code></pre>

<p>报告配置完了，自然要有依赖啊。执行<code>npm install karma-junit-reporter</code>来安装。然后在加上这个plugin:</p>

<pre><code>plugins = [
    'karma-junit-reporter'
];
</code></pre>

<h4>Coverage Reporter</h4>

<p>同JUnit Reporter一样，首先添加：</p>

<pre><code>reporters = ['coverage'];
</code></pre>

<p>进一步的配置coverage report:</p>

<pre><code>coverageReporter = {
    type : 'cobertura',
    dir : 'coverage/'
};
</code></pre>

<p>其中，type用于指出报告类型；dir用于指出生成报告的存放目录。<br/>
type包括：</p>

<ul>
<li>html (default)</li>
<li>lcov (lcov and html)</li>
<li>lcovonly</li>
<li>text (standard output)</li>
<li>text-summary (standard output)</li>
<li>cobertura (xml format supported by Jenkins)</li>
</ul>


<p>下面，需要安装依赖<code>npm install karma-coverage</code>。并在配置文件内添加：</p>

<pre><code>plugins = [
    'karma-coverage'
];
</code></pre>

<h2>创建一个样例</h2>

<p>1.执行‘karma init’,然后根据提示按Tab键进行相关选择。先生成一个默认的配置文件，这个是可以再修改的。</p>

<p>2.创建一个src文件夹，用于存放待测试的JS代码。然后在创建一个test文件夹，用于存放自己写的单元测试代码。</p>

<p>3.以mocha为例，将mocha集成到karma中，使用karma来驱动测试。这需要在karma.conf.js里进行如下配置：</p>

<pre><code>// Karma configuration
// Generated on Tue Mar 19 2013 20:46:08 GMT+0800 (CST)

// base path, that will be used to resolve files and exclude
basePath = './';

frameworks = ['mocha'];

// list of files / patterns to load in the browser
files = [
    {pattern: 'node_modules/chai/chai.js',include: true},
    'src/*.js',
    'test/*.js'
];


// list of files to exclude
exclude = [
    'karma.conf.js'
];


// use dots reporter, as travis terminal does not support escaping sequences
// possible values: 'dots', 'progress', 'junit', 'teamcity'
// CLI --reporters progress
reporters = ['progress','junit','coverage'];

junitReporter = {
    // will be resolved to basePath (in the same way as files/exclude patterns)
    outputFile: 'junit-report/test-results.xml'
};

preprocessors = {
    'src/*.js': 'coverage'
};

//Code Coverage options. report type available:
//- html (default)
//- lcov (lcov and html)
//- lcovonly
//- text (standard output)
//- text-summary (standard output)
//- cobertura (xml format supported by Jenkins)
coverageReporter = {
    // cf. http://gotwarlost.github.com/istanbul/public/apidocs/
    type : 'cobertura',
    dir : 'coverage/'
};


// web server port
port = 9876;


// cli runner port
runnerPort = 9100;


// enable / disable colors in the output (reporters and logs)
colors = true;


// level of logging
// possible values: LOG_DISABLE || LOG_ERROR || LOG_WARN || LOG_INFO || LOG_DEBUG
logLevel = LOG_DEBUG;


// enable / disable watching file and executing tests whenever any file changes
autoWatch = true;


// Start these browsers, currently available:
// - Chrome
// - ChromeCanary
// - Firefox
// - Opera
// - Safari (only Mac)
// - PhantomJS
// - IE (only Windows)
// CLI --browsers Chrome,Firefox,Safari
browsers = ['Chrome'];


// If browser does not capture in given timeout [ms], kill it
captureTimeout = 6000;


// Continuous Integration mode
// if true, it capture browsers, run tests and exit
singleRun = true;


plugins = [
    'karma-mocha',
    'karma-chrome-launcher',
    'karma-firefox-launcher',
    'karma-junit-reporter',
    'karma-coverage'
];
</code></pre>

<p>4.放入相应的代码到src以及test目录里。执行'karma start'命令, 浏览器将会被打开，然后执行相应的Test。效果如下图： <br/>
<img src="/images/blog/karma-chrome.png" alt="Karma in Chrome" /></p>

<p>完整样例代码： <br/>
<a href="https://github.com/blueshen/Karma-mocha-example">https://github.com/blueshen/Karma-mocha-example</a></p>

<h2>IntelliJ IDEA集成</h2>

<p>为了在项目中开发方便，那么在开发中集成到IDE中，会节省N多时间的。下面就先来说说于IDEA的集成。 <br/>
1.安装NodeJS插件： Settings --> IDE Settings --> Plugins --> Browse repositories --> NodeJS  选中，然后右键Download and Install进行安装。重启后成功安装。 <br/>
2.配置Karma Server: 从菜单Run --> Edit Configurations... -->点击 ‘+’新建一个Node.js类型的配置。出现以下的界面：  <br/>
<img src="/images/blog/karma-node-server.png" alt="karma-node-server" /></p>

<p>其中：  <br/>
Name： 任意，本处为Karma node Server <br/>
Path to Node: node可执行全路径。$NODE_PATH/bin/node   <br/>
Working Directory: 当前项目的跟路径 <br/>
Path to Node App JS File: 此处为karma的可执行全路径。 <br/>
Application Parameters: 要执行的命令，此处为start   <br/>
Environment variables: 就是环境变量了。此处我定义了CHROME_BIN来指出CHROME浏览器路径。</p>

<p>3.配置Karma run   <br/>
同Karma Server，只是修改Application Parameters为run
<img src="/images/blog/karma-node-run.png" alt="karma-node-run" /></p>

<p>配置成功后，运行Karma node Server可以看到浏览器就可以正常启动了。console也正确的输出。如同在terminal里执行一般。需要注意的是，本地开发时，需要将<code>singleRun=false</code>,也就是说执行完测试之后不退出。只有在CI环境下才用true。</p>

<p>在浏览器启动之后，如果修改了源代码，Test能否自动执行呢？可以将<code>autoWatch=true</code>,这样当你修改代码后，保存后能自动执行，方便开发了。如果‘autoWatch=false’了，那么这时间就要执行Karma run了，用于在Karma Server上重新执行。</p>
]]></content>
  </entry>
  
</feed>
<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.shenyanchao.cn","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="申艳超-博客">
<meta property="og:url" content="https://www.shenyanchao.cn/index.html">
<meta property="og:site_name" content="申艳超-博客">
<meta property="og:locale">
<meta property="article:author" content="申艳超">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.shenyanchao.cn/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>申艳超-博客</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?81c9612f8fdceca45435ef7f5404d7b2"></script>





  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="申艳超-博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">申艳超-博客</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">搜索引擎、分布式、高性能、NLP、ElasticSearch、Solr</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404.html" rel="section"><i class="heartbeat fa-fw"></i>Commonweal 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="申艳超"
      src="/images/shenyanchao.jpeg">
  <p class="site-author-name" itemprop="name">申艳超</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">133</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">244</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/blueshen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;blueshen" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhiyi.shen@gmail.com" title="E-Mail → mailto:zhiyi.shen@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/blueshen" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.shenyanchao.cn/blog/2020/01/16/geo-quadtrees/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shenyanchao.jpeg">
      <meta itemprop="name" content="申艳超">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="申艳超-博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 申艳超-博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2020/01/16/geo-quadtrees/" class="post-title-link" itemprop="url">空间搜索-Quad Tree</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-16 22:03:21" itemprop="dateCreated datePublished" datetime="2020-01-16T22:03:21+08:00">2020-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-09 11:39:39" itemprop="dateModified" datetime="2022-11-09T11:39:39+08:00">2022-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/geo/" itemprop="url" rel="index"><span itemprop="name">geo</span></a>
        </span>
    </span>

  
    <span id="/blog/2020/01/16/geo-quadtrees/" class="post-meta-item leancloud_visitors" data-flag-title="空间搜索-Quad Tree" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="/images/geo-quadtree/5cff54de-5133-4369-8680-52d2723eb756.jpg" alt="geo quad tree"></p>
<h3 id="Quad-Tree四叉树"><a href="#Quad-Tree四叉树" class="headerlink" title="Quad Tree四叉树"></a>Quad Tree四叉树</h3><p><a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Quadtree">四叉树</a> 是一种非常简单的空间索引技术。在四叉树中，每个节点代表一个bbox，该bbox覆盖被索引空间的某些部分，而根节点则覆盖整个区域。每个节点要么是一个叶子节点-在这种情况下，它包含一个或多个索引点，并且没有子级；要么是一个内部节点，在这种情况下，它正好具有四个子级，每个象限一个子级，方法是将沿两个轴的一半-因此得名。</p>
<p><img src="/images/geo-quadtree/geo-quadtree-nearest.jpeg" alt="geo-quadtree-nearest"><br>四叉树如何划分索引区域的表示。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2020/01/16/geo-quadtrees/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.shenyanchao.cn/blog/2020/01/16/geo_data_format/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shenyanchao.jpeg">
      <meta itemprop="name" content="申艳超">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="申艳超-博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 申艳超-博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2020/01/16/geo_data_format/" class="post-title-link" itemprop="url">空间搜索-数据格式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-16 22:03:21" itemprop="dateCreated datePublished" datetime="2020-01-16T22:03:21+08:00">2020-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-09 11:39:39" itemprop="dateModified" datetime="2022-11-09T11:39:39+08:00">2022-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/geo/" itemprop="url" rel="index"><span itemprop="name">geo</span></a>
        </span>
    </span>

  
    <span id="/blog/2020/01/16/geo_data_format/" class="post-meta-item leancloud_visitors" data-flag-title="空间搜索-数据格式" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="/images/geo-data-format/geojson-bj.jpeg" alt="geojson-bj"></p>
<h3 id="几何对象类型"><a href="#几何对象类型" class="headerlink" title="几何对象类型"></a>几何对象类型</h3><ul>
<li>Point  点</li>
<li>MultiPoint 多点</li>
<li>LineString  线条</li>
<li>MultiLineString 多线条</li>
<li>Polygon   多边形</li>
<li>MultiPolygon N个多边形</li>
<li>GeometryCollection 几何图形集合</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2020/01/16/geo_data_format/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.shenyanchao.cn/blog/2020/01/16/geo_geohash/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shenyanchao.jpeg">
      <meta itemprop="name" content="申艳超">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="申艳超-博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 申艳超-博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2020/01/16/geo_geohash/" class="post-title-link" itemprop="url">空间搜索-GeoHash</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-16 22:03:21" itemprop="dateCreated datePublished" datetime="2020-01-16T22:03:21+08:00">2020-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-09 11:39:39" itemprop="dateModified" datetime="2022-11-09T11:39:39+08:00">2022-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/geo/" itemprop="url" rel="index"><span itemprop="name">geo</span></a>
        </span>
    </span>

  
    <span id="/blog/2020/01/16/geo_geohash/" class="post-meta-item leancloud_visitors" data-flag-title="空间搜索-GeoHash" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="/images/geo-geohash/global-geohash.jpeg" alt="global-geohash"></p>
<hr>
<h2 id="一-GeoHash-算法"><a href="#一-GeoHash-算法" class="headerlink" title="一. GeoHash 算法"></a>一. GeoHash 算法</h2><h3 id="1-Geohash-算法简介"><a href="#1-Geohash-算法简介" class="headerlink" title="1. Geohash 算法简介"></a>1. Geohash 算法简介</h3><p>Geohash 是一种地理编码，由 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/w/index.php?title=Gustavo_Niemeyer&action=edit&redlink=1">Gustavo Niemeyer</a> 在2008年发明的，G.M.Morton在1966年做过类似的工作。。它是一种分级的数据结构，把空间划分为网格。Geohash 属于空间填充曲线中的 Z 阶曲线（<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Z-order_curve">Z-order curve</a>）的实际应用。</p>
<p>何为 Z 阶曲线？<br><img src="/images/geo/z-order-line.png" alt="z"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2020/01/16/geo_geohash/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.shenyanchao.cn/blog/2020/01/16/geo_google_s2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shenyanchao.jpeg">
      <meta itemprop="name" content="申艳超">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="申艳超-博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 申艳超-博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2020/01/16/geo_google_s2/" class="post-title-link" itemprop="url">google s2 希尔伯特曲线</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-16 22:03:21" itemprop="dateCreated datePublished" datetime="2020-01-16T22:03:21+08:00">2020-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-09 11:58:51" itemprop="dateModified" datetime="2022-11-09T11:58:51+08:00">2022-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/geo/" itemprop="url" rel="index"><span itemprop="name">geo</span></a>
        </span>
    </span>

  
    <span id="/blog/2020/01/16/geo_google_s2/" class="post-meta-item leancloud_visitors" data-flag-title="google s2 希尔伯特曲线" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="/images/geo_google_s2/s2_global_intro.png" alt="google s2 希尔伯特曲线"></p>
<p>S2其实是来自几何数学中<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/N%E7%BB%B4%E7%90%83%E9%9D%A2">N维球面</a>的一个数学符号<strong>S²</strong>，它表示的是3维空间内的2维球面。S2 这个库其实是被设计用来解决球面上各种几何问题的。</p>
<p>接下来就看看怎么用 S2 来解决多维空间点索引的问题的。</p>
<h3 id="球面坐标转换"><a href="#球面坐标转换" class="headerlink" title="球面坐标转换"></a>球面坐标转换</h3><p>众所周知，地球是近似一个球体。球体是一个三维的，如何把三维降成一维呢？</p>
<p>球面上的一个点，在直角坐标系中，可以这样表示：</p>
<p><img src="/images/geo/3-axises-point.png" alt="三维坐标"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">x</span> = <span class="string">r * sin θ * cos φ</span></span><br><span class="line"><span class="attr">y</span> = <span class="string">r * sin θ * sin φ </span></span><br><span class="line"><span class="attr">z</span> = <span class="string">r * cos θ</span></span><br></pre></td></tr></table></figure>

<p>通常地球上的点我们会用经纬度来表示。</p>
<p><img src="/images/geo/global-point.png"></p>
<p>再进一步，我们可以和球面上的经纬度联系起来。不过这里需要注意的是，纬度的角度 α 和直角坐标系下的球面坐标 θ 加起来等于 90°。所以三角函数要注意转换。</p>
<p>于是地球上任意的一个经纬度的点，就可以转换成<code> f(x,y,z)</code>。</p>
<p>在 S2 中，地球半径被当成单位1了，所以半径不用考虑。x,y,z的值域都被限定在了<code>[-1,1]*[-1,1]*[-1,1]</code>这个区间之内了。</p>
<h3 id="球面变平面"><a href="#球面变平面" class="headerlink" title="球面变平面"></a>球面变平面</h3><p>接下来一步 S2 把球面碾成平面。怎么做的呢？</p>
<p>首先在地球外面套了一个外切的正方体，如下图。</p>
<p><img src="/images/geo/56_33.png" alt="正六边形投影"></p>
<p>从球心向外切正方体6个面分别投影。S2 是把球面上所有的点都投影到外切正方体的6个面上。</p>
<p><img src="/images/geo/projection.png" alt="正方体投影"></p>
<p>这里简单的画了一个投影图，上图左边的是投影到正方体一个面的示意图，实际上影响到的球面是右边那张图。</p>
<p><img src="/images/geo/projection_0.png"></p>
<p>从侧面看，其中一个球面投影到正方体其中一个面上，边缘与圆心的连线相互之间的夹角为90°，但是和x，y，z轴的角度是45°。我们可以在球的6个方向上，把45°的辅助圆画出来，见下图左边。</p>
<p><img src="/images/geo/six-face-global.png"></p>
<p>上图左边的图画了6个辅助线，蓝线是前后一对，红线是左右一对，绿线是上下一对。分别都是45°的地方和圆心连线与球面相交的点的轨迹。这样我们就可以把投影到外切正方体6个面上的球面画出来，见上图右边。</p>
<p>投影到正方体以后，我们就可以把这个正方体展开了。</p>
<p><img src="/images/geo/six-face-global-spread.png" alt="地图正方体投影展开"></p>
<p>一个正方体的展开方式有很多种。不管怎么展开，最小单元都是一个正方形。</p>
<p>在 Google S2 中，它是把地球展开成如下的样子：</p>
<p><img src="/images/geo/s2_0.png" alt="地球S2投影">这样第一步的球面坐标进一步的被转换成<code> f(x,y,z) -&gt; g(face,u,v)</code>，其中：</p>
<p>face是正方形的6个面(0~5)，u,v对应的是六个面中的一个面上的坐标。</p>
<h3 id="球面矩形投影修正"><a href="#球面矩形投影修正" class="headerlink" title="球面矩形投影修正"></a>球面矩形投影修正</h3><p>上一步我们把球面上的球面矩形投影到正方形的某个面上，形成的形状类似于矩形，但是由于球面上角度的不同，最终会导致即使是投影到同一个面上，每个矩形的面积也不大相同。</p>
<p><img src="/images/geo/global-s2-projection-modify.png"></p>
<p>上图就表示出了球面上个一个球面矩形投影到正方形一个面上的情况。</p>
<p><img src="/images/geo/s2-area-modify.png" alt="球面投影修正"></p>
<p>经过实际计算发现，最大的面积和最小的面积相差<strong>5.2倍</strong>。见上图左边。相同的弧度区间，在不同的纬度上投影到正方体上的面积不同。</p>
<p>现在就需要修正各个投影出来形状的面积。如何选取合适的映射修正函数就成了关键。目标是能达到上图右边的样子，让各个矩形的面积尽量相同。</p>
<p>这块转换的的不同如下表所示:</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">面积比率</th>
<th align="center">边比率</th>
<th align="center">对角线比率</th>
<th align="center">ToPointRaw</th>
<th align="center">ToPoint</th>
<th align="center">FromPoint</th>
</tr>
</thead>
<tbody><tr>
<td align="center">线性变换</td>
<td align="center">5.200</td>
<td align="center">2.117</td>
<td align="center">2.959</td>
<td align="center">0.020</td>
<td align="center">0.087</td>
<td align="center">0.085</td>
</tr>
<tr>
<td align="center">tan()变换</td>
<td align="center">1.414</td>
<td align="center">1.414</td>
<td align="center">1.704</td>
<td align="center">0.237</td>
<td align="center">0.299</td>
<td align="center">0.258</td>
</tr>
<tr>
<td align="center">二次变换</td>
<td align="center">2.082</td>
<td align="center">1.802</td>
<td align="center">1.932</td>
<td align="center">0.033</td>
<td align="center">0.096</td>
<td align="center">0.108</td>
</tr>
</tbody></table>
<p>线性变换是最快的变换，但是变换比最小。</p>
<p><strong>tan变换</strong>可以使每个投影以后的矩形的面积更加一致，最大和最小的矩形比例仅仅只差0.414。可以说非常接近了。但是 tan函数的调用耗时较长。如果把所有点都按照这种方式计算的话，性能将会降低3倍。</p>
<p>最后google默认选择的是<strong>二次变换</strong>，这是一个近似切线的投影曲线。它的计算速度远远快于 tan，大概是 tan计算的3倍速度。生成的投影以后的矩形大小也类似。不过最大的矩形和最小的矩形相比依旧有2.082的比率。</p>
<p>上表中，<code>ToPoint</code>和<code>FromPoint</code> 分别是把单位向量转换到 Cell ID 所需要的毫秒数、把 Cell ID 转换回单位向量所需的毫秒数（Cell ID 就是投影到正方体6个面，某个面上矩形的 ID，矩形称为 Cell，它对应的 ID 称为 Cell ID）。<code>ToPointRaw</code>是某种目的下，把 Cell ID 转换为非单位向量所需的毫秒数。</p>
<p>所以投影之后的修正函数三种变换应该如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 线性转换</span></span><br><span class="line">u = <span class="number">0.5</span> * ( u + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// tan变换</span></span><br><span class="line">u = <span class="number">2</span> / pi * (atan(u) + pi / <span class="number">4</span>) = <span class="number">2</span> * atan(u) / pi + <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 二次变换</span></span><br><span class="line">u &gt;= <span class="number">0</span>，u = <span class="number">0.5</span> * sqrt(<span class="number">1</span> + <span class="number">3</span>*u)</span><br><span class="line">u &lt; <span class="number">0</span>,    u = <span class="number">1</span> - <span class="number">0.5</span> * sqrt(<span class="number">1</span> - <span class="number">3</span>*u)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>经过修正变换以后，u，v都变换成了s，t。值域也发生了变化。u，v的值域是[-1,1]，变换以后，是s，t的值域是[0,1]。</p>
<p>至此，小结一下，球面上的点S(lat,lng) -&gt; f(x,y,z) -&gt; g(face,u,v) -&gt; h(face,s,t)。目前总共转换了4步，球面经纬度坐标转换成球面(x,y,z)坐标，再转换成外切正方体投影面上的坐标g(face, u,v)，最后变换成修正后的坐标h(face, s, t)。</p>
<h3 id="点与坐标轴点相互转换"><a href="#点与坐标轴点相互转换" class="headerlink" title="点与坐标轴点相互转换"></a>点与坐标轴点相互转换</h3><p>在 S2 算法中，默认划分 Cell 的等级是30，也就是说把一个正方形划分为 2^30 * 2^30个小的正方形。</p>
<p>那么上一步的h(face , s, t)映射到这个正方形上面来，对应该如何转换呢？</p>
<p><img src="/images/geo/s2-cell.png"></p>
<p>s，t的值域是[0,1]，现在值域要扩大到[0, 2^30-1]。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">S2CellId::STtoIJ</span><span class="params">(<span class="type">double</span> s)</span> &#123;</span><br><span class="line">  <span class="comment">// Converting from floating-point to integers via static_cast is very slow</span></span><br><span class="line">  <span class="comment">// on Intel processors because it requires changing the rounding mode.</span></span><br><span class="line">  <span class="comment">// Rounding to the nearest integer using FastIntRound() is much faster.</span></span><br><span class="line">  <span class="comment">// 这里减去0.5是为了四舍五入</span></span><br><span class="line">  <span class="keyword">return</span> max(<span class="number">0</span>, min(kMaxSize - <span class="number">1</span>, MathUtil::FastIntRound(kMaxSize * s - <span class="number">0.5</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>到这一步，是h(face,s,t) -&gt; H(face,i,j)。</p>
<h3 id="坐标轴点与希尔伯特曲线-Cell-ID-相互转换"><a href="#坐标轴点与希尔伯特曲线-Cell-ID-相互转换" class="headerlink" title="坐标轴点与希尔伯特曲线 Cell ID 相互转换"></a>坐标轴点与希尔伯特曲线 Cell ID 相互转换</h3><p>最后一步，如何把 i，j 和希尔伯特曲线上的点关联起来呢？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	lookupBits = <span class="number">4</span></span><br><span class="line">	swapMask   = <span class="number">0x01</span></span><br><span class="line">	invertMask = <span class="number">0x02</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	ijToPos = [<span class="number">4</span>][<span class="number">4</span>]<span class="type">int</span>&#123;</span><br><span class="line">		&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>&#125;, <span class="comment">// canonical order</span></span><br><span class="line">		&#123;<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>&#125;, <span class="comment">// axes swapped</span></span><br><span class="line">		&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>&#125;, <span class="comment">// bits inverted</span></span><br><span class="line">		&#123;<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">0</span>&#125;, <span class="comment">// swapped &amp; inverted</span></span><br><span class="line">	&#125;</span><br><span class="line">	posToIJ = [<span class="number">4</span>][<span class="number">4</span>]<span class="type">int</span>&#123;</span><br><span class="line">		&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>&#125;, <span class="comment">// canonical order:    (0,0), (0,1), (1,1), (1,0)</span></span><br><span class="line">		&#123;<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>&#125;, <span class="comment">// axes swapped:       (0,0), (1,0), (1,1), (0,1)</span></span><br><span class="line">		&#123;<span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>&#125;, <span class="comment">// bits inverted:      (1,1), (1,0), (0,0), (0,1)</span></span><br><span class="line">		&#123;<span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>&#125;, <span class="comment">// swapped &amp; inverted: (1,1), (0,1), (0,0), (1,0)</span></span><br><span class="line">	&#125;</span><br><span class="line">	posToOrientation = [<span class="number">4</span>]<span class="type">int</span>&#123;swapMask, <span class="number">0</span>, <span class="number">0</span>, invertMask | swapMask&#125;</span><br><span class="line">	lookupIJ         [<span class="number">1</span> &lt;&lt; (<span class="number">2</span>*lookupBits + <span class="number">2</span>)]<span class="type">int</span></span><br><span class="line">	lookupPos        [<span class="number">1</span> &lt;&lt; (<span class="number">2</span>*lookupBits + <span class="number">2</span>)]<span class="type">int</span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在变换之前，先来解释一下定义的一些变量。</p>
<p>posToIJ 代表的是一个矩阵，里面记录了一些单元希尔伯特曲线的位置信息。</p>
<p>把 posToIJ 数组里面的信息用图表示出来，如下图：</p>
<p><img src="/images/geo/s2-hilbert-convert.png"></p>
<p>同理，把 ijToPos 数组里面的信息用图表示出来，如下图：</p>
<p><img src="/images/geo/s2-ijToPos.png"></p>
<p>posToOrientation 数组里面装了4个数字，分别是1,0,0,3。<br>lookupIJ 和 lookupPos 分别是两个容量为1024的数组。这里面分别对应的就是希尔伯特曲线 ID 转换成坐标轴 IJ 的转换表，和坐标轴 IJ 转换成希尔伯特曲线 ID 的转换表。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	initLookupCell(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">	initLookupCell(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, swapMask, <span class="number">0</span>, swapMask)</span><br><span class="line">	initLookupCell(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, invertMask, <span class="number">0</span>, invertMask)</span><br><span class="line">	initLookupCell(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, swapMask|invertMask, <span class="number">0</span>, swapMask|invertMask)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里是初始化的递归函数，在希尔伯特曲线的标准顺序中可以看到是有4个格子，并且格子都有顺序的，所以初始化要遍历满所有顺序。入参的第4个参数，就是从0 - 3 。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// initLookupCell initializes the lookupIJ table at init time.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initLookupCell</span><span class="params">(level, i, j, origOrientation, pos, orientation <span class="type">int</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> level == lookupBits &#123;</span><br><span class="line">		ij := (i &lt;&lt; lookupBits) + j</span><br><span class="line">		lookupPos[(ij&lt;&lt;<span class="number">2</span>)+origOrientation] = (pos &lt;&lt; <span class="number">2</span>) + orientation</span><br><span class="line">		lookupIJ[(pos&lt;&lt;<span class="number">2</span>)+origOrientation] = (ij &lt;&lt; <span class="number">2</span>) + orientation</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	level++</span><br><span class="line">	i &lt;&lt;= <span class="number">1</span></span><br><span class="line">	j &lt;&lt;= <span class="number">1</span></span><br><span class="line">	pos &lt;&lt;= <span class="number">2</span></span><br><span class="line">	</span><br><span class="line">	r := posToIJ[orientation]</span><br><span class="line">	</span><br><span class="line">	initLookupCell(level, i+(r[<span class="number">0</span>]&gt;&gt;<span class="number">1</span>), j+(r[<span class="number">0</span>]&amp;<span class="number">1</span>), origOrientation, pos, orientation^posToOrientation[<span class="number">0</span>])</span><br><span class="line">	initLookupCell(level, i+(r[<span class="number">1</span>]&gt;&gt;<span class="number">1</span>), j+(r[<span class="number">1</span>]&amp;<span class="number">1</span>), origOrientation, pos+<span class="number">1</span>, orientation^posToOrientation[<span class="number">1</span>])</span><br><span class="line">	initLookupCell(level, i+(r[<span class="number">2</span>]&gt;&gt;<span class="number">1</span>), j+(r[<span class="number">2</span>]&amp;<span class="number">1</span>), origOrientation, pos+<span class="number">2</span>, orientation^posToOrientation[<span class="number">2</span>])</span><br><span class="line">	initLookupCell(level, i+(r[<span class="number">3</span>]&gt;&gt;<span class="number">1</span>), j+(r[<span class="number">3</span>]&amp;<span class="number">1</span>), origOrientation, pos+<span class="number">3</span>, orientation^posToOrientation[<span class="number">3</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>上面这个函数是生成希尔伯特曲线的。我们可以看到有一处对<code>pos &lt;&lt; 2</code>的操作，这里是把位置变换到第一个4个小格子中，所以位置乘以了4。</p>
<p>由于初始设置的<code>lookupBits = 4</code>，所以i，j的变化范围是从[0,15]，总共有16*16&#x3D;256个，然后i，j坐标是表示的4个格子，再细分，<code>lookupBits = 4</code>这种情况下能表示的点的个数就是256*4&#x3D;1024个。这也正好是 lookupIJ 和 lookupPos 的总容量。</p>
<p>画一个局部的图，i，j从 0-7 变化。</p>
<p><img src="/images/geo/ij-hilbert.png"></p>
<p>上图是一个4阶希尔伯特曲线。初始化的实际过程就是初始化4阶希尔伯特上的1024个点的坐标与坐标轴上的x，y轴的对应关系表。</p>
<p>举个例子，下表是i，j在递归过程中产生的中间过程。下表是lookupPos 表计算过程。</p>
<table>
<thead>
<tr>
<th align="center">(i,j)</th>
<th align="center">ij</th>
<th align="center">ij 计算过程</th>
<th align="center">lookupPos[i j]</th>
<th align="center">lookupPos[i j]计算过程</th>
<th align="center">实际坐标</th>
</tr>
</thead>
<tbody><tr>
<td align="center">(0,0)</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">(0,0)</td>
</tr>
<tr>
<td align="center">(1,0)</td>
<td align="center">64</td>
<td align="center">(1*16+0)*4&#x3D;64</td>
<td align="center">5</td>
<td align="center">1*4+1&#x3D;5</td>
<td align="center">(3,0)</td>
</tr>
<tr>
<td align="center">(1,1)</td>
<td align="center">68</td>
<td align="center">(1*16+1)*4&#x3D;68</td>
<td align="center">9</td>
<td align="center">2*4+1&#x3D;9</td>
<td align="center">(3,2)</td>
</tr>
<tr>
<td align="center">(0,1)</td>
<td align="center">4</td>
<td align="center">(0*16+1)*4&#x3D;4</td>
<td align="center">14</td>
<td align="center">3*4+2&#x3D;14</td>
<td align="center">(0,2)</td>
</tr>
<tr>
<td align="center">(0,2)</td>
<td align="center">8</td>
<td align="center">(0*16+2)*4&#x3D;8</td>
<td align="center">17</td>
<td align="center">4*4+1&#x3D;17</td>
<td align="center">(1,4)</td>
</tr>
<tr>
<td align="center">(0,3)</td>
<td align="center">12</td>
<td align="center">(0*16+3)*4&#x3D;12</td>
<td align="center">20</td>
<td align="center">5*4+0&#x3D;20</td>
<td align="center">(0,6)</td>
</tr>
<tr>
<td align="center">(1,3)</td>
<td align="center">76</td>
<td align="center">(1*16+3)*4&#x3D;76</td>
<td align="center">24</td>
<td align="center">6*4+0&#x3D;24</td>
<td align="center">(2,6)</td>
</tr>
<tr>
<td align="center">(1,2)</td>
<td align="center">72</td>
<td align="center">(1*16+2)*4&#x3D;72</td>
<td align="center">31</td>
<td align="center">7*4+3&#x3D;31</td>
<td align="center">(3,4)</td>
</tr>
<tr>
<td align="center">(2,2)</td>
<td align="center">136</td>
<td align="center">(2*16+2)*4&#x3D;136</td>
<td align="center">33</td>
<td align="center">8*4+1&#x3D;33</td>
<td align="center">(5,4)</td>
</tr>
</tbody></table>
<p>取出一行详细分析一下计算过程。</p>
<p>假设当前(i,j)&#x3D;(0,2)，ij 的计算过程是把 i 左移4位再加上 j，整体结果再左移2位。目的是为了留出2位的方向位置。ij的前4位是i，接着4位是j，最后2位是方向。这样计算出ij的值就是8 。</p>
<p>接着计算lookupPos[i j]的值。从上图中可以看到(0,2)代表的单元格的4个数字是16，17，18，19 。计算到这一步，pos的值为4（pos是专门记录生成格子到第几个了，总共pos的值会循环0-255）。pos代表的是当前是第几个格子(4个小格子组成)，当前是第4个，每个格子里面有4个小格子。所以4*4就可以偏移到当前格子的第一个数字，也就是16 。posToIJ 数组里面会记录下当前格子的形状。从这里我们从中取出 orientation 。</p>
<p>看上图，16，17，18，19对应的是 posToIJ 数组轴旋转的情况，所以17是位于轴旋转图的数字1代表的格子中。这时 orientation &#x3D; 1 。</p>
<p>这样 lookupPos[i j] 表示的数字就计算出来了，4*4+1&#x3D;17 。这里就完成了i，j与希尔伯特曲线上数字的对应。</p>
<p>那如何由希尔伯特曲线上的数字对应到实际的坐标呢？</p>
<p>lookupIJ 数组里面记录了反向的信息。lookupIJ 数组 和 lookupPos 数组存储的信息正好是反向的。lookupIJ 数组 下表存的值是 lookupPos 数组 的下表。我们查  lookupIJ 数组 ，lookupIJ[17]的值就是8，对应算出来(i,j)&#x3D;(0,2)。这个时候的i，j还是大格子。还是需要借助 posToIJ 数组 里面描述的形状信息。当前形状是轴旋转，之前也知道 orientation &#x3D; 1，由于每个坐标里面有4个小格子，所以一个i，j代表的是2个小格子，所以需要乘以2，再加上形状信息里面的方向，可以计算出实际的坐标 (0 * 2 + 1 , 2 * 2 + 0) &#x3D; ( 1，4) 。</p>
<p>至此，整个球面坐标的坐标映射就已经完成了。</p>
<p>球面上的点S(lat,lng) -&gt; f(x,y,z) -&gt; g(face,u,v) -&gt; h(face,s,t)  -&gt; H(face,i,j) -&gt; CellID。目前总共转换了6步，球面经纬度坐标转换成球面xyz坐标，再转换成外切正方体投影面上的坐标，最后变换成修正后的坐标，再坐标系变换，映射到 [0,2^30^-1]区间，最后一步就是把坐标系上的点都映射到希尔伯特曲线上。</p>
<h3 id="S2-Cell-ID-数据结构"><a href="#S2-Cell-ID-数据结构" class="headerlink" title="S2 Cell ID 数据结构"></a>S2 Cell ID 数据结构</h3><p>最后需要来谈谈 S2 Cell ID 数据结构，这个数据结构直接关系到不同 Level 对应精度的问题。</p>
<p><img src="/images/geo_google_s2/s2-cell.png"></p>
<p>上图左图中对应的是 Level 30 的情况，右图对应的是 Level 24 的情况。(2的多少次方，角标对应的也就是 Level 的值)</p>
<p>在 S2 中，每个 CellID 是由64位的组成的。可以用一个 uint64 存储。开头的3位表示正方体6个面中的一个，取值范围[0,5]。3位可以表示0-7，但是6，7是无效值。</p>
<p>64位的最后一位是1，这一位是特意留出来的。用来快速查找中间有多少位。从末尾最后一位向前查找，找到第一个不为0的位置，即找到第一个1。这一位的前一位到开头的第4位（因为前3位被占用）都是可用数字。</p>
<p>绿色格子有多少个就能表示划分多少格。上图左图，绿色的有60个格子，于是可以表示[0,2^30^ -1] * [0,2^30^ -1]这么多个格子。上图右图中，绿色格子只有48个，那么就只能表示[0,2^24^ -1]*[0,2^24^ -1]这么多个格子。</p>
<p>那么不同 level 可以代表的网格的面积究竟是多大呢？</p>
<p>由上一章我们知道，由于投影的原因，所以导致投影之后的面积依旧有大小差别。</p>
<table>
<thead>
<tr>
<th align="left">层(level)</th>
<th align="right">最小面积</th>
<th align="right">最大面积</th>
<th align="right">平均面积</th>
<th align="right">单位</th>
<th align="right">Random cell 1 (UK) min edge length</th>
<th align="right">Random cell 1 (UK) max edge length</th>
<th align="right">Random cell 2 (US) min edge length</th>
<th align="right">Random cell 2 (US) max edge length</th>
<th align="right">Cell个数</th>
</tr>
</thead>
<tbody><tr>
<td align="left">00</td>
<td align="right">85011012.19</td>
<td align="right">85011012.19</td>
<td align="right">85011012.19</td>
<td align="right">km2</td>
<td align="right">7842 km</td>
<td align="right">7842 km</td>
<td align="right">7842 km</td>
<td align="right">7842 km</td>
<td align="right">6</td>
</tr>
<tr>
<td align="left">01</td>
<td align="right">21252753.05</td>
<td align="right">21252753.05</td>
<td align="right">21252753.05</td>
<td align="right">km2</td>
<td align="right">3921 km</td>
<td align="right">5004 km</td>
<td align="right">3921 km</td>
<td align="right">5004 km</td>
<td align="right">24</td>
</tr>
<tr>
<td align="left">02</td>
<td align="right">4919708.23</td>
<td align="right">6026521.16</td>
<td align="right">5313188.26</td>
<td align="right">km2</td>
<td align="right">1825 km</td>
<td align="right">2489 km</td>
<td align="right">1825 km</td>
<td align="right">2489 km</td>
<td align="right">96</td>
</tr>
<tr>
<td align="left">03</td>
<td align="right">1055377.48</td>
<td align="right">1646455.50</td>
<td align="right">1328297.07</td>
<td align="right">km2</td>
<td align="right">840 km</td>
<td align="right">1167 km</td>
<td align="right">1130 km</td>
<td align="right">1310 km</td>
<td align="right">384</td>
</tr>
<tr>
<td align="left">04</td>
<td align="right">231564.06</td>
<td align="right">413918.15</td>
<td align="right">332074.27</td>
<td align="right">km2</td>
<td align="right">432 km</td>
<td align="right">609 km</td>
<td align="right">579 km</td>
<td align="right">636 km</td>
<td align="right">1536</td>
</tr>
<tr>
<td align="left">05</td>
<td align="right">53798.67</td>
<td align="right">104297.91</td>
<td align="right">83018.57</td>
<td align="right">km2</td>
<td align="right">210 km</td>
<td align="right">298 km</td>
<td align="right">287 km</td>
<td align="right">315 km</td>
<td align="right">6K</td>
</tr>
<tr>
<td align="left">06</td>
<td align="right">12948.81</td>
<td align="right">26113.30</td>
<td align="right">20754.64</td>
<td align="right">km2</td>
<td align="right">108 km</td>
<td align="right">151 km</td>
<td align="right">143 km</td>
<td align="right">156 km</td>
<td align="right">24K</td>
</tr>
<tr>
<td align="left">07</td>
<td align="right">3175.44</td>
<td align="right">6529.09</td>
<td align="right">5188.66</td>
<td align="right">km2</td>
<td align="right">54 km</td>
<td align="right">76 km</td>
<td align="right">72 km</td>
<td align="right">78 km</td>
<td align="right">98K</td>
</tr>
<tr>
<td align="left">08</td>
<td align="right">786.20</td>
<td align="right">1632.45</td>
<td align="right">1297.17</td>
<td align="right">km2</td>
<td align="right">27 km</td>
<td align="right">38 km</td>
<td align="right">36 km</td>
<td align="right">39 km</td>
<td align="right">393K</td>
</tr>
<tr>
<td align="left">09</td>
<td align="right">195.59</td>
<td align="right">408.12</td>
<td align="right">324.29</td>
<td align="right">km2</td>
<td align="right">14 km</td>
<td align="right">19 km</td>
<td align="right">18 km</td>
<td align="right">20 km</td>
<td align="right">1573K</td>
</tr>
<tr>
<td align="left">10</td>
<td align="right">48.78</td>
<td align="right">102.03</td>
<td align="right">81.07</td>
<td align="right">km2</td>
<td align="right">7 km</td>
<td align="right">9 km</td>
<td align="right">9 km</td>
<td align="right">10 km</td>
<td align="right">6M</td>
</tr>
<tr>
<td align="left">11</td>
<td align="right">12.18</td>
<td align="right">25.51</td>
<td align="right">20.27</td>
<td align="right">km2</td>
<td align="right">3 km</td>
<td align="right">5 km</td>
<td align="right">4 km</td>
<td align="right">5 km</td>
<td align="right">25M</td>
</tr>
<tr>
<td align="left">12</td>
<td align="right">3.04</td>
<td align="right">6.38</td>
<td align="right">5.07</td>
<td align="right">km2</td>
<td align="right">1699 m</td>
<td align="right">2 km</td>
<td align="right">2 km</td>
<td align="right">2 km</td>
<td align="right">100M</td>
</tr>
<tr>
<td align="left">13</td>
<td align="right">0.76</td>
<td align="right">1.59</td>
<td align="right">1.27</td>
<td align="right">km2</td>
<td align="right">850 m</td>
<td align="right">1185 m</td>
<td align="right">1123 m</td>
<td align="right">1225 m</td>
<td align="right">402M</td>
</tr>
<tr>
<td align="left">14</td>
<td align="right">0.19</td>
<td align="right">0.40</td>
<td align="right">0.32</td>
<td align="right">km2</td>
<td align="right">425 m</td>
<td align="right">593 m</td>
<td align="right">562 m</td>
<td align="right">613 m</td>
<td align="right">1610M</td>
</tr>
<tr>
<td align="left">15</td>
<td align="right">47520.30</td>
<td align="right">99638.93</td>
<td align="right">79172.67</td>
<td align="right">m2</td>
<td align="right">212 m</td>
<td align="right">296 m</td>
<td align="right">281 m</td>
<td align="right">306 m</td>
<td align="right">6B</td>
</tr>
<tr>
<td align="left">16</td>
<td align="right">11880.08</td>
<td align="right">24909.73</td>
<td align="right">19793.17</td>
<td align="right">m2</td>
<td align="right">106 m</td>
<td align="right">148 m</td>
<td align="right">140 m</td>
<td align="right">153 m</td>
<td align="right">25B</td>
</tr>
<tr>
<td align="left">17</td>
<td align="right">2970.02</td>
<td align="right">6227.43</td>
<td align="right">4948.29</td>
<td align="right">m2</td>
<td align="right">53 m</td>
<td align="right">74 m</td>
<td align="right">70 m</td>
<td align="right">77 m</td>
<td align="right">103B</td>
</tr>
<tr>
<td align="left">18</td>
<td align="right">742.50</td>
<td align="right">1556.86</td>
<td align="right">1237.07</td>
<td align="right">m2</td>
<td align="right">27 m</td>
<td align="right">37 m</td>
<td align="right">35 m</td>
<td align="right">38 m</td>
<td align="right">412B</td>
</tr>
<tr>
<td align="left">19</td>
<td align="right">185.63</td>
<td align="right">389.21</td>
<td align="right">309.27</td>
<td align="right">m2</td>
<td align="right">13 m</td>
<td align="right">19 m</td>
<td align="right">18 m</td>
<td align="right">19 m</td>
<td align="right">1649B</td>
</tr>
<tr>
<td align="left">20</td>
<td align="right">46.41</td>
<td align="right">97.30</td>
<td align="right">77.32</td>
<td align="right">m2</td>
<td align="right">7 m</td>
<td align="right">9 m</td>
<td align="right">9 m</td>
<td align="right">10 m</td>
<td align="right">7T</td>
</tr>
<tr>
<td align="left">21</td>
<td align="right">11.60</td>
<td align="right">24.33</td>
<td align="right">19.33</td>
<td align="right">m2</td>
<td align="right">3 m</td>
<td align="right">5 m</td>
<td align="right">4 m</td>
<td align="right">5 m</td>
<td align="right">26T</td>
</tr>
<tr>
<td align="left">22</td>
<td align="right">2.90</td>
<td align="right">6.08</td>
<td align="right">4.83</td>
<td align="right">m2</td>
<td align="right">166 cm</td>
<td align="right">2 m</td>
<td align="right">2 m</td>
<td align="right">2 m</td>
<td align="right">105T</td>
</tr>
<tr>
<td align="left">23</td>
<td align="right">0.73</td>
<td align="right">1.52</td>
<td align="right">1.21</td>
<td align="right">m2</td>
<td align="right">83 cm</td>
<td align="right">116 cm</td>
<td align="right">110 cm</td>
<td align="right">120 cm</td>
<td align="right">422T</td>
</tr>
<tr>
<td align="left">24</td>
<td align="right">0.18</td>
<td align="right">0.38</td>
<td align="right">0.30</td>
<td align="right">m2</td>
<td align="right">41 cm</td>
<td align="right">58 cm</td>
<td align="right">55 cm</td>
<td align="right">60 cm</td>
<td align="right">1689T</td>
</tr>
<tr>
<td align="left">25</td>
<td align="right">453.19</td>
<td align="right">950.23</td>
<td align="right">755.05</td>
<td align="right">cm2</td>
<td align="right">21 cm</td>
<td align="right">29 cm</td>
<td align="right">27 cm</td>
<td align="right">30 cm</td>
<td align="right">7e15</td>
</tr>
<tr>
<td align="left">26</td>
<td align="right">113.30</td>
<td align="right">237.56</td>
<td align="right">188.76</td>
<td align="right">cm2</td>
<td align="right">10 cm</td>
<td align="right">14 cm</td>
<td align="right">14 cm</td>
<td align="right">15 cm</td>
<td align="right">27e15</td>
</tr>
<tr>
<td align="left">27</td>
<td align="right">28.32</td>
<td align="right">59.39</td>
<td align="right">47.19</td>
<td align="right">cm2</td>
<td align="right">5 cm</td>
<td align="right">7 cm</td>
<td align="right">7 cm</td>
<td align="right">7 cm</td>
<td align="right">108e15</td>
</tr>
<tr>
<td align="left">28</td>
<td align="right">7.08</td>
<td align="right">14.85</td>
<td align="right">11.80</td>
<td align="right">cm2</td>
<td align="right">2 cm</td>
<td align="right">4 cm</td>
<td align="right">3 cm</td>
<td align="right">4 cm</td>
<td align="right">432e15</td>
</tr>
<tr>
<td align="left">29</td>
<td align="right">1.77</td>
<td align="right">3.71</td>
<td align="right">2.95</td>
<td align="right">cm2</td>
<td align="right">12 mm</td>
<td align="right">18 mm</td>
<td align="right">17 mm</td>
<td align="right">18 mm</td>
<td align="right">1729e15</td>
</tr>
<tr>
<td align="left">30</td>
<td align="right">0.44</td>
<td align="right">0.93</td>
<td align="right">0.74</td>
<td align="right">cm2</td>
<td align="right">6 mm</td>
<td align="right">9 mm</td>
<td align="right">8 mm</td>
<td align="right">9 mm</td>
<td align="right">7e18</td>
</tr>
</tbody></table>
<p>level 0 就是正方体的六个面之一。地球表面积约等于510,100,000 km^2。level 0 的面积就是地球表面积的六分之一。level 30 能表示的最小的面积0.48cm^2，最大也就0.93cm^2 。</p>
<h3 id="S2-与-Geohash-对比"><a href="#S2-与-Geohash-对比" class="headerlink" title="S2 与 Geohash 对比"></a>S2 与 Geohash 对比</h3><p>Geohash 有12级，从5000km 到 3.7cm。中间每一级的变化比较大。有时候可能选择上一级会大很多，选择下一级又会小一些。比如选择字符串长度为4，它对应的 cell 宽度是39.1km，需求可能是50km，那么选择字符串长度为5，对应的 cell 宽度就变成了156km，瞬间又大了3倍了。这种情况选择多长的 Geohash 字符串就比较难选。选择不好，每次判断可能就还需要取出周围的8个格子再次进行判断。Geohash 需要 12 bytes 存储。</p>
<p>S2 有30级，从 0.7cm²  到 85,000,000km² 。中间每一级的变化都比较平缓，接近于4次方的曲线。所以选择精度不会出现 Geohash 选择困难的问题。S2 的存储只需要一个 uint64 即可存下。</p>
<p>S2 库里面不仅仅有地理编码，还有其他很多几何计算相关的库。地理编码只是其中的一小部分。本文没有介绍到的 S2 的实现还有很多很多，各种向量计算，面积计算，多边形覆盖，距离问题，球面球体上的问题，它都有实现。</p>
<p>S2 还能解决多边形覆盖的问题。比如给定一个城市，求一个多边形刚刚好覆盖住这个城市。</p>
<p><img src="/images/geo/s2-city-cover.png"></p>
<p>如上图，生成的多边形刚刚好覆盖住下面蓝色的区域。这里生成的多边形可以有大有小。不管怎么样，最终的结果也是刚刚覆盖住目标物。</p>
<p><img src="/images/geo/s2-stpaul.png"></p>
<p>用相同的 Cell 也可以达到相同的目的，上图就是用相同 Level 的 Cell 覆盖了整个圣保罗城市。</p>
<p>这些都是 Geohash 做不到的。</p>
<p>多边形覆盖利用的是近似的算法，虽然不是严格意义上的最优解，但是实践中效果特别好。</p>
<p>额外值得说明的一点是，Google 文档上强调了，这种多边形覆盖的算法虽然对搜索和预处理操作非常有用，但是“不可依赖”的。理由也是因为是近似算法，并不是唯一最优算法，所以得到的解会依据库的不同版本而产生变化。</p>
<h3 id="8-S2-Cell-举例"><a href="#8-S2-Cell-举例" class="headerlink" title="8. S2 Cell 举例"></a>8. S2 Cell 举例</h3><p>先来看看经纬度和 CellID 的转换，以及矩形面积的计算。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">latlng := s2.LatLngFromDegrees(<span class="number">31.232135</span>, <span class="number">121.41321700000003</span>)</span><br><span class="line">cellID := s2.CellIDFromLatLng(latlng)</span><br><span class="line">cell := s2.CellFromCellID(cellID) <span class="comment">//9279882742634381312</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// cell.Level()</span></span><br><span class="line">fmt.Println(<span class="string">&quot;latlng = &quot;</span>, latlng)</span><br><span class="line">fmt.Println(<span class="string">&quot;cell level = &quot;</span>, cellID.Level())</span><br><span class="line">fmt.Printf(<span class="string">&quot;cell = %d\n&quot;</span>, cellID)</span><br><span class="line">smallCell := s2.CellFromCellID(cellID.Parent(<span class="number">10</span>))</span><br><span class="line">fmt.Printf(<span class="string">&quot;smallCell level = %d\n&quot;</span>, smallCell.Level())</span><br><span class="line">fmt.Printf(<span class="string">&quot;smallCell id = %b\n&quot;</span>, smallCell.ID())</span><br><span class="line">fmt.Printf(<span class="string">&quot;smallCell ApproxArea = %v\n&quot;</span>, smallCell.ApproxArea())</span><br><span class="line">fmt.Printf(<span class="string">&quot;smallCell AverageArea = %v\n&quot;</span>, smallCell.AverageArea())</span><br><span class="line">fmt.Printf(<span class="string">&quot;smallCell ExactArea = %v\n&quot;</span>, smallCell.ExactArea())</span><br></pre></td></tr></table></figure>

<p>这里 Parent 方法参数可以直接指定返回改点的对应 level 的 CellID。</p>
<p>上面那些方法打印出来的结果如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">latlng =  [<span class="number">31.2321350</span>, <span class="number">121.4132170</span>]</span><br><span class="line">cell level =  <span class="number">30</span></span><br><span class="line">cell = <span class="number">3869277663051577529</span></span><br><span class="line"></span><br><span class="line">****Parent **** <span class="number">10000000000000000000000000000000000000000</span></span><br><span class="line">smallCell level = <span class="number">10</span></span><br><span class="line">smallCell id = <span class="number">11010110110010011011110000000000000000000000000000000000000000</span></span><br><span class="line">smallCell ApproxArea = <span class="number">1.9611002454714756e-06</span></span><br><span class="line">smallCell AverageArea = <span class="number">1.997370817559429e-06</span></span><br><span class="line">smallCell ExactArea = <span class="number">1.9611009480261058e-06</span></span><br></pre></td></tr></table></figure>

<p>再举一个覆盖多边形的例子。我们先随便创建一个区域。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rect = s2.RectFromLatLng(s2.LatLngFromDegrees(<span class="number">48.99</span>, <span class="number">1.852</span>))</span><br><span class="line">rect = rect.AddPoint(s2.LatLngFromDegrees(<span class="number">48.68</span>, <span class="number">2.75</span>))</span><br><span class="line"></span><br><span class="line">rc := &amp;s2.RegionCoverer&#123;MaxLevel: <span class="number">20</span>, MaxCells: <span class="number">10</span>, MinLevel: <span class="number">2</span>&#125;</span><br><span class="line">r := s2.Region(rect.CapBound())</span><br><span class="line">covering := rc.Covering(r)</span><br></pre></td></tr></table></figure>


<p>覆盖参数设置成 level 2 - 20，最多的 Cell 的个数是10个。</p>
<p><img src="/images/geo/s2-cell-10.png"></p>
<p>接着我们把 Cell 至多改成20个。</p>
<p><img src="/images/geo/s2-cell-20.png"></p>
<p>最后再改成30个。</p>
<p><img src="/images/geo/s2-cell-30.png"></p>
<p>可以看到相同的 level 的范围，cell 个数越多越精确目标范围。</p>
<p>这里是匹配矩形区域，匹配圆形区域也同理。</p>
<p><img src="/images/geo/s2-circle-cover_0.png"></p>
<p><img src="/images/geo/s2-circle-cover-1.png"></p>
<p>代码就不贴了，与矩形类似。这种功能 Geohash 就做不到，需要自己手动实现了。</p>
<p>最后举一个多边形匹配的例子。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ll1 := s2.LatLngFromDegrees(<span class="number">31.803269</span>, <span class="number">113.421145</span>)</span><br><span class="line">	ll2 := s2.LatLngFromDegrees(<span class="number">31.461846</span>, <span class="number">113.695803</span>)</span><br><span class="line">	ll3 := s2.LatLngFromDegrees(<span class="number">31.250756</span>, <span class="number">113.756228</span>)</span><br><span class="line">	ll4 := s2.LatLngFromDegrees(<span class="number">30.902604</span>, <span class="number">113.997927</span>)</span><br><span class="line">	ll5 := s2.LatLngFromDegrees(<span class="number">30.817726</span>, <span class="number">114.464846</span>)</span><br><span class="line">	ll6 := s2.LatLngFromDegrees(<span class="number">30.850743</span>, <span class="number">114.76697</span>)</span><br><span class="line">	ll7 := s2.LatLngFromDegrees(<span class="number">30.713884</span>, <span class="number">114.997683</span>)</span><br><span class="line">	ll8 := s2.LatLngFromDegrees(<span class="number">30.430111</span>, <span class="number">115.42615</span>)</span><br><span class="line">	ll9 := s2.LatLngFromDegrees(<span class="number">30.088491</span>, <span class="number">115.640384</span>)</span><br><span class="line">	ll10 := s2.LatLngFromDegrees(<span class="number">29.907713</span>, <span class="number">115.656863</span>)</span><br><span class="line">	ll11 := s2.LatLngFromDegrees(<span class="number">29.783833</span>, <span class="number">115.135012</span>)</span><br><span class="line">	ll12 := s2.LatLngFromDegrees(<span class="number">29.712295</span>, <span class="number">114.728518</span>)</span><br><span class="line">	ll13 := s2.LatLngFromDegrees(<span class="number">29.55473</span>, <span class="number">114.24512</span>)</span><br><span class="line">	ll14 := s2.LatLngFromDegrees(<span class="number">29.530835</span>, <span class="number">113.717776</span>)</span><br><span class="line">	ll15 := s2.LatLngFromDegrees(<span class="number">29.55473</span>, <span class="number">113.3772</span>)</span><br><span class="line">	ll16 := s2.LatLngFromDegrees(<span class="number">29.678892</span>, <span class="number">112.998172</span>)</span><br><span class="line">	ll17 := s2.LatLngFromDegrees(<span class="number">29.941039</span>, <span class="number">112.349978</span>)</span><br><span class="line">	ll18 := s2.LatLngFromDegrees(<span class="number">30.040949</span>, <span class="number">112.025882</span>)</span><br><span class="line">	ll19 := s2.LatLngFromDegrees(<span class="number">31.803269</span>, <span class="number">113.421145</span>)</span><br><span class="line"></span><br><span class="line">	point1 := s2.PointFromLatLng(ll1)</span><br><span class="line">	point2 := s2.PointFromLatLng(ll2)</span><br><span class="line">	point3 := s2.PointFromLatLng(ll3)</span><br><span class="line">	point4 := s2.PointFromLatLng(ll4)</span><br><span class="line">	point5 := s2.PointFromLatLng(ll5)</span><br><span class="line">	point6 := s2.PointFromLatLng(ll6)</span><br><span class="line">	point7 := s2.PointFromLatLng(ll7)</span><br><span class="line">	point8 := s2.PointFromLatLng(ll8)</span><br><span class="line">	point9 := s2.PointFromLatLng(ll9)</span><br><span class="line">	point10 := s2.PointFromLatLng(ll10)</span><br><span class="line">	point11 := s2.PointFromLatLng(ll11)</span><br><span class="line">	point12 := s2.PointFromLatLng(ll12)</span><br><span class="line">	point13 := s2.PointFromLatLng(ll13)</span><br><span class="line">	point14 := s2.PointFromLatLng(ll14)</span><br><span class="line">	point15 := s2.PointFromLatLng(ll15)</span><br><span class="line">	point16 := s2.PointFromLatLng(ll16)</span><br><span class="line">	point17 := s2.PointFromLatLng(ll17)</span><br><span class="line">	point18 := s2.PointFromLatLng(ll18)</span><br><span class="line">	point19 := s2.PointFromLatLng(ll19)</span><br><span class="line"></span><br><span class="line">	points := []s2.Point&#123;&#125;</span><br><span class="line">	points = <span class="built_in">append</span>(points, point19)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point18)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point17)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point16)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point15)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point14)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point13)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point12)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point11)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point10)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point9)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point8)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point7)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point6)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point5)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point4)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point3)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point2)</span><br><span class="line">	points = <span class="built_in">append</span>(points, point1)</span><br><span class="line"></span><br><span class="line">	loop := s2.LoopFromPoints(points)</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;----  loop search (gets too much) -----&quot;</span>)</span><br><span class="line">	<span class="comment">// fmt.Printf(&quot;Some loop status items: empty:%t   full:%t \n&quot;, loop.IsEmpty(), loop.IsFull())</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// ref: https://github.com/golang/geo/issues/14#issuecomment-257064823</span></span><br><span class="line">	defaultCoverer := &amp;s2.RegionCoverer&#123;MaxLevel: <span class="number">20</span>, MaxCells: <span class="number">1000</span>, MinLevel: <span class="number">1</span>&#125;</span><br><span class="line">	<span class="comment">// rg := s2.Region(loop.CapBound())</span></span><br><span class="line">	<span class="comment">// cvr := defaultCoverer.Covering(rg)</span></span><br><span class="line">	cvr := defaultCoverer.Covering(loop)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// fmt.Println(poly.CapBound())</span></span><br><span class="line">	<span class="keyword">for</span> _, c3 := <span class="keyword">range</span> cvr &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;%d,\n&quot;</span>, c3)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>这里用到了 Loop 类，这个类的初始化的最小单元是 Point，Point 是由经纬度产生的。<strong>最重要的一点需要注意的是，多边形是按照逆时针方向，左手边区域确定的。</strong></p>
<p>如果一不小心点是按照顺时针排列的话，那么多边形确定的是外层更大的面，意味着球面除去画的这个多边形以外的都是你想要的多边形。</p>
<p>举个具体的例子，假如我们想要画的多边形是下图这个样子的：</p>
<p><img src="/images/geo/s2-polygon.png"></p>
<p>如果我们用顺时针的方式依次存储 Point 的话，并用顺时针的这个数组去初始化 Loop，那么就会出现“奇怪”的现象。如下图：</p>
<p><img src="/images/geo/s2-polygon-weired.png"></p>
<p>这张图左上角的顶点和右下角的顶点在地球上是重合的。如果把这个地图重新还原成球面，那么就是整个球面中间挖空了一个多边形。</p>
<p>把上图放大，如下图：</p>
<p><img src="/images/geo/s2-polygon_1.png"></p>
<p>这样就可以很清晰的看到了，中间被挖空了一个多边形。造成这种现象的原因就是按照顺时针的方向存储了每个点，那么初始化一个 Loop 的时候就会选择多边形外圈的更大的多边形。</p>
<p>使用 Loop 一定要切记，<strong>顺时针表示的是外圈多边形，逆时针表示的是内圈多边形。</strong></p>
<p>多边形覆盖的问题同之前举的例子一样：</p>
<p>相同的 MaxLevel &#x3D; 20，MinLevel &#x3D; 1，MaxCells 不同，覆盖的精度就不同，下图是 MaxCells &#x3D; 100 的情况：</p>
<p><img src="/images/geo/s2-level-cell.png"></p>
<p>下图是 MaxCells &#x3D; 1000 的情况：</p>
<p><img src="/images/geo/s2-level-cell-1000.png"></p>
<p>从这个例子也可以看出来  相同的 Level 范围，MaxCells 越精度，覆盖的精度越高。</p>
<h3 id="9-S2-的应用"><a href="#9-S2-的应用" class="headerlink" title="9. S2 的应用"></a>9. S2 的应用</h3><p>S2 主要能用在以下 8 个地方：</p>
<ol>
<li>涉及到角度，间隔，纬度经度点，单位矢量等的表示，以及对这些类型的各种操作。  </li>
<li>单位球体上的几何形状，如球冠（“圆盘”），纬度 - 经度矩形，折线和多边形。  </li>
<li>支持点，折线和多边形的任意集合的强大的构造操作（例如联合）和布尔谓词（例如，包含）。  </li>
<li>对点，折线和多边形的集合进行快速的内存索引。  </li>
<li>针对测量距离和查找附近物体的算法。  </li>
<li>用于捕捉和简化几何的稳健算法（该算法具有精度和拓扑保证）。  </li>
<li>用于测试几何对象之间关系的有效且精确的数学谓词的集合。  </li>
<li>支持空间索引，包括将区域近似为离散“S2单元”的集合。此功能可以轻松构建大型分布式空间索引。</li>
</ol>
<hr>
<p>参考文档：</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.shenyanchao.cn/blog/2020/01/16/geo_lucene_solr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shenyanchao.jpeg">
      <meta itemprop="name" content="申艳超">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="申艳超-博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 申艳超-博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2020/01/16/geo_lucene_solr/" class="post-title-link" itemprop="url">空间搜索-Lucene-Solr使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-16 22:03:21" itemprop="dateCreated datePublished" datetime="2020-01-16T22:03:21+08:00">2020-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-09 11:39:39" itemprop="dateModified" datetime="2022-11-09T11:39:39+08:00">2022-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/geo/" itemprop="url" rel="index"><span itemprop="name">geo</span></a>
        </span>
    </span>

  
    <span id="/blog/2020/01/16/geo_lucene_solr/" class="post-meta-item leancloud_visitors" data-flag-title="空间搜索-Lucene-Solr使用" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="/images/geo-lucene/geo-lucene-header.png" alt="lucene solr es geo"></p>
<p>在Lucene-Solr中，提供了空间搜索能力，它主要提供了以下4种FieldType来支持：</p>
<ul>
<li><code>LatLonPointSpatialField</code></li>
<li><code>LatLonType</code> (不再使用) , 以及非地理位置搜索版本 <code>PointType</code></li>
<li><code>SpatialRecursivePrefixTreeFieldType</code> (简写RPT), 包含衍生出的<code>RptWithGeometrySpatialField</code></li>
<li><code>BBoxField</code></li>
</ul>
<p>LatLonPointSpatialField是用来取代LatLonType的一个FieldType。Lucene在7.0之后，推出了一种基于<a href="http://www.shenyanchao.cn/blog/2018/12/04/lucene-bkd/">BKD树</a>而实现的专用于处理多维数据的[索引格式，它原则上可以高效的处理任意维的数据。从一维的(int, long, double)数据类型、二维的点、面类型、三维的空间类型，甚至更多维度数据（暂未实现而已）。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">&quot;location&quot;</span> <span class="attr">class</span>=<span class="string">&quot;solr.LatLonPointSpatialField&quot;</span> <span class="attr">docValues</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>BBoxField是一种专门用来索引四方形数据的FieldType, 提供的功能包括：图形相交、图形内部、图形包含、图形相等。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;bbox&quot;</span> <span class="attr">type</span>=<span class="string">&quot;bbox&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">&quot;bbox&quot;</span> <span class="attr">class</span>=<span class="string">&quot;solr.BBoxField&quot;</span> <span class="attr">geo</span>=<span class="string">&quot;true&quot;</span> <span class="attr">distanceUnits</span>=<span class="string">&quot;kilometers&quot;</span> <span class="attr">numberType</span>=<span class="string">&quot;pdouble&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">&quot;pdouble&quot;</span> <span class="attr">class</span>=<span class="string">&quot;solr.DoublePointField&quot;</span> <span class="attr">docValues</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>SpatialRecursivePrefixTreeFieldType</strong>则是最为通用的空间搜索解决方案。下面将对其重点来进行解释。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2020/01/16/geo_lucene_solr/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.shenyanchao.cn/blog/2020/01/16/geo_projection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shenyanchao.jpeg">
      <meta itemprop="name" content="申艳超">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="申艳超-博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 申艳超-博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2020/01/16/geo_projection/" class="post-title-link" itemprop="url">空间搜索-地球投影</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-16 22:03:21" itemprop="dateCreated datePublished" datetime="2020-01-16T22:03:21+08:00">2020-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-09 11:39:39" itemprop="dateModified" datetime="2022-11-09T11:39:39+08:00">2022-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/geo/" itemprop="url" rel="index"><span itemprop="name">geo</span></a>
        </span>
    </span>

  
    <span id="/blog/2020/01/16/geo_projection/" class="post-meta-item leancloud_visitors" data-flag-title="空间搜索-地球投影" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="/images/geo-projection/1920px-Mercator_projection_SW.jpg" alt="世界地图-墨卡托"></p>
<p>大比例尺制图中实际用到的投影有27种+之多，其中最重要的有：墨卡托(Mercator)投影(85%)，Lambert等角正割圆锥投影(5%)，Albers等积正割圆锥投影，等距圆锥投影, 最为常用的是横轴墨卡托投影。</p>
<p>具体来说，不同的地理区域常用的地图投影方法也不同。</p>
<p>投影种类繁多，命名也极其繁杂，有很多其实是同一类投影，单是叫法很容易混淆。下面进行一个清晰的讲解，让大家了解一下各种投影的区别。</p>
<h3 id="投影方式"><a href="#投影方式" class="headerlink" title="投影方式"></a>投影方式</h3><h4 id="投影性质划分"><a href="#投影性质划分" class="headerlink" title="投影性质划分"></a>投影性质划分</h4><p>按投影后，在地图上的表示不同，分为<strong>等积投影</strong>、<strong>等角投影</strong></p>
<p><img src="/images/geo-projection/v2-43e383472900684ad1007545feb3b2e9_hd.png"></p>
<p>所谓等积投影，就是不同地理位置上投影后的面积是一样的，面积上比例是一样的。</p>
<p>等角投影，主要是指投影后，角度(经度或者纬度)是不变的。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2020/01/16/geo_projection/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.shenyanchao.cn/blog/2020/01/16/geo_space_filling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shenyanchao.jpeg">
      <meta itemprop="name" content="申艳超">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="申艳超-博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 申艳超-博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2020/01/16/geo_space_filling/" class="post-title-link" itemprop="url">空间搜索-分形几何</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-16 22:03:21" itemprop="dateCreated datePublished" datetime="2020-01-16T22:03:21+08:00">2020-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-09 11:50:26" itemprop="dateModified" datetime="2022-11-09T11:50:26+08:00">2022-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/geo/" itemprop="url" rel="index"><span itemprop="name">geo</span></a>
        </span>
    </span>

  
    <span id="/blog/2020/01/16/geo_space_filling/" class="post-meta-item leancloud_visitors" data-flag-title="空间搜索-分形几何" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="空间搜索-分形几何"><a href="#空间搜索-分形几何" class="headerlink" title="空间搜索-分形几何"></a>空间搜索-分形几何</h1><p><img src="/images/geo_space_filling/750px-Mandel_zoom_00_mandelbrot_set.jpg" alt="曼德博集合"></p>
<h1 id="分形-fractal"><a href="#分形-fractal" class="headerlink" title="分形(fractal)"></a>分形(fractal)</h1><p><strong>分形</strong>（英语：fractal，源自拉丁语：frāctus，有“零碎”、“破裂”之意），又称<strong>碎形</strong>、<strong>残形</strong>，通常被定义为“一个粗糙或零碎的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%87%A0%E4%BD%95%E5%BD%A2%E7%8A%B6">几何形状</a>，可以分成数个部分，且每一部分都（至少近似地）是整体缩小后的形状”，即具有<strong>自相似</strong>的性质。 分形在数学中是一种抽象的物体，用于描述自然界中存在的事物。1975 年<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%9C%AC%E8%8F%AF%C2%B7%E6%9B%BC%E5%BE%B7%E5%8D%9A">本华·曼德博</a>首次提出“分形(fractal)”这个术语。</p>
<p>关于分形的具体定义，权威专家也仍有一些争论，即使作为”分形几何之父“，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%9C%AC%E8%8F%AF%C2%B7%E6%9B%BC%E5%BE%B7%E5%8D%9A">本华·曼德博</a>也一直更新其定义。<br>“<strong>美丽、（研究起来）极其困难但又非常的有用，这就是分形</strong>”。1982年更新为：”<strong>分形是一种其豪斯多夫维数严格大于拓扑维数的集合</strong>“，后来称为”<strong>分形是由与整体在某些方面相似的部分构成的图形</strong>“ 。又过了一段时间，决定这样描述分形：“**…在研究和使用分形时，不需要迂腐的定义。用分形维数作为描述各种不同分型的通用术语**”。</p>
<p>通常认为, 理论分型是无限迭代、自相似的、具有分形维数的详细数学结构。<br>是不是看完以上的描述，还是不太了解什么是分形，那么我们来看几个现实中的例子。</p>
<table>
<thead>
<tr>
<th>花椰菜</th>
<th>蕨类植物</th>
</tr>
</thead>
<tbody><tr>
<td><img src="/images/geo_space_filling/v2-ab1d66d2cba49cfa930d6f754991ae2e_hd.jpg" alt="img"></td>
<td><img src="/images/geo_space_filling/v2-c25495c39e569de4f6dc2b7b7b6a8fd4_hd.jpg" alt="img"></td>
</tr>
</tbody></table>
<p>可以看出，每个花椰菜的凸起，单独拿出来其实都和花椰菜是一样的造型。蕨类植物的叶子，没个分支都和整体的形状一致。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%9C%AC%E8%8F%AF%C2%B7%E6%9B%BC%E5%BE%B7%E5%8D%9A">本华·曼德博</a>提出”关于英大不列颠岛的海岸线到底有多长？”这样的问题，他用分形几何给出的答案是无限长。</p>
<p><img src="/images/geo_space_filling/british_bench.jpeg" alt="british_bench"></p>
<p>可以看出，在不同的比例尺下，去量海岸线的长度是不一样的。200KM比例尺海岸线约2300KM，而100KM比例尺则达到了2800KM，如果是50KM的比例尺，海岸长度达到了3500KM。试想一想，当比例尺越小，能够描绘的越精细，这个海岸线的长度也不断趋向于无限。</p>
<p>这个问题，回归到分形本身，其实就是针对直线这一图形，不断进行分形细分，直线分割越来越小。但是仍旧是一个直线(自相似)。</p>
<p>分形与其他几何图形相似但又有所不同。当你缩放一个图形时，你就能看出分形和其他几何图形的区别。将一个多边形的边长加倍，它的面积变为原来的四倍。新的边长与旧边长相比增加了 2 倍，而面积增加了 4 倍，即 2^2倍。平面内的多边形在二维空间中，指数 2 刚好是多边形所在的二维空间的维数。类似的，对于三维空间中的球，如果它的半径加倍，则它的体积变为原来的 8 倍，即2^3 倍，指数 3 依旧是球所在空间的维数。</p>
<p>如果将分形的一维长度加倍，如将康托三分集的初始线段长加倍，分型空间的内容2^n倍，此时<em>n</em> 不一定是个整数。幂指数<em>n</em> 称为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%BD%A2%E7%BB%B4%E6%95%B0">分型的维数</a>，它通常大于分型的拓扑维数。</p>
<p><img src="/images/geo_space_filling/729px-Cantor_set_in_seven_iterations.svg.png" alt="Cantor ternary set, in seven iterations"></p>
<p>要做出<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%A7%91%E8%B5%AB%E9%9B%AA%E8%8A%B1">科赫雪花</a>，将正三角形每边中央三分之一的线段以一对同长的线段取代，形成一个等腰的“凸角”。再对上一步骤所形成的每一边做同样的动作。每一次<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BF%AD%E4%BB%A3">迭代</a>，总长度增加三分之一。科赫雪花即是无限次迭代的结果，有无限长的周长，但其面积还是有限的。因此，科赫雪花和其他相似构造有时会被称为“怪兽曲线”。</p>
<p>下图是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%A7%91%E8%B5%AB%E9%9B%AA%E8%8A%B1">科赫雪花</a>的动态展示：<br><img src="/images/geo_space_filling/200px-Von_Koch_curve.gif" alt="img"></p>
<p>分形的“<strong>自我相似</strong>”的特征很容易通过类比来理解，就像用镜头或其他设备放大数字图像，从而发现以前不可见的、更精细的新结构。如果你放大一个分形的图像，则不会出现新的细节；图像没什么变化，相似的图案一遍又一遍的重复出现。对于有些分形几乎完全一样的图像会不断地重复。 自我相似的特征并非反直觉的。人们在生活中也能看到自我相似的现象，例如：两面平行的镜子间的无限重复、山上庙里老和尚的故事里的山…分形的不同之处在于重复的图案一定有详细的细节。</p>
<p>细节性的概念和分形的另一个特征——<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%BD%A2%E7%BB%B4%E6%95%B0"><strong>分形维数</strong></a>有关。分形维数不需要数学背景，也很容易理解：分形的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%BD%A2%E7%BB%B4%E6%95%B0">分形维数</a>大于它的拓扑维数，通过将分形尺度与普通的几何形状相比较，我们便能感受到他们的差别。举个例子，通常认为直线是是一维的，如果直线被分为三部分，每部分都是原来的 1&#x2F;3 长，你会得到相等的三部分。相比之下，科赫雪花的拓扑维数是 1，和普通的直线一样，但它的分形维数大于 1，因为它有很多的细节。雪花曲线被分为原长的 1&#x2F;3，得到的是 4 条原始雪花曲线重组组合的结果。这种与众不同的关系是<strong>分形维数</strong>的基础。</p>
<p>这也引出了第三个特征：分形在数学上是处处不可微的。具体的说，这意味着分形不能用传统的方法测量。测量非分型曲线，如波浪曲线的长度，只要放大到足够大，总能用直线拟合一小段曲线，然后就能用卷尺测量这段直线的长度，再将各段直线长度相加，就可以得出波浪的长度。这样做实质上是把曲线看作数学上的函数，在一小段范围内取一阶泰勒展开，近似为直线，然后求和总长度。但分型曲线是处处不可微的，如果尝试使用直线去拟合分形曲线，如科赫雪花曲线，缩放的过程永远不会停止，因为曲线图案的重复模式总会不断地出现，每次缩放，都需要使用更小的卷尺来贴合曲线。</p>
<p>分形一般有以下特质：</p>
<ul>
<li>在任意小的尺度上都能有精细的结构；</li>
<li>太不规则，以至无论是其整体或局部都难以用传统<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%AC%A7%E6%B0%8F%E5%87%A0%E4%BD%95">欧氏几何</a>的语言来描述；</li>
<li>具有（至少是近似的或<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BB%9F%E8%AE%A1">统计</a>的）<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%87%AA%E7%9B%B8%E4%BC%BC">自相似</a>形式；</li>
<li>一般地，其“分形维数”（通常为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%B1%AA%E6%96%AF%E5%A4%9A%E5%A4%AB%E7%BB%B4%E6%95%B0">豪斯多夫维数</a>）会大于<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8B%93%E6%92%B2%E7%B6%AD%E6%95%B8">拓扑维数</a>（希尔伯特曲线是相等的）；</li>
<li>在多数情况下有着简单的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%80%92%E5%BD%92%E5%AE%9A%E4%B9%89">递归定义</a>。</li>
</ul>
<p>因为分形在所有的大小尺度下都显得相似，所以通常被认为是无限复杂的。</p>
<p>一类分形的典型例子有: 康托尔集、龙形曲线，谢尔宾斯基三角形和地毯、门格海绵、、皮亚诺曲线等。</p>
<table>
<thead>
<tr>
<th>龙形曲线</th>
<th>Gosper 曲线</th>
<th>谢尔宾斯基三角</th>
<th>谢尔宾斯基地毯</th>
</tr>
</thead>
<tbody><tr>
<td><img src="/images/geo/curve_0.png"></td>
<td><img src="/images/geo/curve_1.png"></td>
<td><img src="/images/geo_space_filling/200px-Animated_construction_of_Sierpinski_Triangle.gif"></td>
<td><img src="/images/geo_space_filling/220px-Sierpinski_carpet_6.svg.png" alt="谢尔宾斯基地毯"></td>
</tr>
</tbody></table>
<p>分形可以是<strong>确定性</strong>的，如上述所有的分形；也可以是<strong>随机的</strong>(即非确定性的)。</p>
<p>比如说，平面上布朗运动的轨迹的豪斯多夫维数等于2。实际上，布朗粒子的轨迹由大量无规则可循的折线组成，是一种处处连续但处处不可微的曲线，是一种无规分形曲线，它也具有自相似性，但这种自相似性具有<strong>统计的</strong>性质。<br>分形也可以依据其自相似来分类，有如下三种：</p>
<ul>
<li><strong>精确自相似</strong>：这是最强的一种自相似，分形在任一尺度下都显得一样。由迭代函数系统定义出的分形通常会展现出精确自相似来。</li>
<li><strong>半自相似</strong>：这是一种较松的自相似，分形在不同尺度下会显得大略（但非精确）相同。半自相似分形包含有整个分形扭曲及退化形式的缩小尺寸。由递推关系式定义出的分形通常会是半自相似，但不会是精确自相似。</li>
<li><strong>统计自相似</strong>：这是最弱的一种自相似，这种分形在不同尺度下都能保有固定的数值或统计测度。大多数对“分形”合理的定义自然会导致某一类型的统计自相似（<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%BD%A2%E7%BB%B4%E6%95%B0">分形维数</a>本身即是个在不同尺度下都保持固定的数值测度）。随机分形是统计自相似，但非精确及半自相似的分形的一个例子。</li>
</ul>
<p>现在有一些软件可以很好的画出精确自相似分形图形，甚至作为工艺品出售：</p>
<p><img src="/images/geo_space_filling/fractal_0.jpg" alt="img"></p>
<p><img src="/images/geo_space_filling/fractal_1.jpg" alt="img"></p>
<h2 id="空间填充曲线"><a href="#空间填充曲线" class="headerlink" title="空间填充曲线"></a>空间填充曲线</h2><p>空间填充曲线目前来看其实就是<strong>分形</strong>的一种，它解决了这一难题：能否用一条无限长的线，穿过任意维度空间里面的所有点？</p>
<p><img src="/images/geo/peano.png" alt="Peano曲线"></p>
<p>在1890年，<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Giuseppe_Peano">Giuseppe Peano</a>发现了一条连续曲线，现在称为 <strong>Peano 曲线</strong>，它可以穿过单位正方形上的每个点。他的目的是构建一个可以从单位区间到单位正方形的连续映射。 Peano 受到 Georg Cantor 早期违反直觉的研究结果的启发，即单位区间中无限数量的点与任何有限维度流型中无限数量的点，基数相同。 Peano 解决的问题实质就是，是否存在这样一个连续的映射，一条能填充满平面的曲线。上图就是他找到的一条曲线。</p>
<p>一般来说，一维的东西是不可能填满2维的方格的。但是Peano曲线恰恰给出了反例。</p>
<p>Peano曲线的构造方法如下：</p>
<p>取一个正方形并且把它分出<strong>九个相等</strong>的小正方形，然后从左下角的正方形开始至右上角的正方形结束，依次把小正方形的<strong>中心</strong>用线段连接起来；下一步把每个小正方形分成九个相等的正方形，然后上述方式把其中中心连接起来……将这种操作手续无限进行下去，最终得到的极限情况的曲线就被称作<strong>Peano曲线</strong>。</p>
<p>皮亚诺对区间[0,1]上的点和正方形上的点的映射作了详细的数学描述。实际上，正方形的这些点对于<img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/31a5c18739ff04858eecc8fec2f53912c348e0e5">，可找到两个连续函数 x &#x3D; f(t) 和 y &#x3D; g(t)，使得 x 和 y 取属于单位正方形的每一个值。</p>
<p>一年后，即1891年，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9">希尔伯特</a>发明了另外一个曲线，叫希尔伯特曲线（Hilbert curve）。具体步骤如下。</p>
<p><img src="/images/geo/hilbert-curve.png"></p>
<p><em>上图就是1-6阶的希尔伯特曲线</em>。</p>
<p>同样的原理，希尔伯特曲线也可以扩展到3D空间，如下图所示。</p>
<p><img src="/images/geo/hilbert-curve-3d.png"></p>
<p>在数学分析中，空间填充曲线是一个参数化的注入函数，它将单位区间映射到单位正方形，立方体，更广义的，n维超立方体等中的连续曲线，随着参数的增加，它可以任意接近单位立方体中的给定点。填充曲线也是多种多样的。如下所示：</p>
<p><img src="/images/geo/curve_4.png" alt="填充曲线"></p>
<p>除了数学重要性之外，空间填充曲线也可用于降维，数学规划，稀疏多维数据库索引，电子学和生物学。空间填充曲线的现在被用在互联网地图中。</p>
<h2 id="Hilbert-Curve-希尔伯特曲线"><a href="#Hilbert-Curve-希尔伯特曲线" class="headerlink" title="Hilbert Curve 希尔伯特曲线"></a>Hilbert Curve 希尔伯特曲线</h2><h3 id="希尔伯特曲线的定义"><a href="#希尔伯特曲线的定义" class="headerlink" title="希尔伯特曲线的定义"></a>希尔伯特曲线的定义</h3><p><img src="/images/geo_space_filling/c4dfb-sv8yq.gif" alt="希尔伯特曲线填充"></p>
<p><strong>希尔伯特曲线</strong>一种能填充满一个平面正方形的分形曲线（<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=%E7%A9%BA%E9%96%93%E5%A1%AB%E5%85%85%E6%9B%B2%E7%B7%9A&action=edit&redlink=1">空间填充曲线</a>），由<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%A4%A7%E8%A1%9B%C2%B7%E5%B8%8C%E7%88%BE%E4%BC%AF%E7%89%B9">大卫·希尔伯特</a>在1891年提出。由于它能填满平面，它的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%B1%AA%E6%96%AF%E5%A4%9A%E5%A4%AB%E7%B6%AD">豪斯多夫维</a>是2。取它填充的正方形的边长为1，第n步的希尔伯特曲线的长度是2^n - 2^(-n)。</p>
<h3 id="希尔伯特曲线的构造方法"><a href="#希尔伯特曲线的构造方法" class="headerlink" title="希尔伯特曲线的构造方法"></a>希尔伯特曲线的构造方法</h3><p><img src="https://upload.wikimedia.org/wikipedia/commons/7/7c/Hilbert-curve_rounded-gradient-animated.gif" alt="img"></p>
<p>一阶的希尔伯特曲线，生成方法就是把正方形四等分(<strong>4个小正方形</strong>)，从其中一个子正方形的中心开始(原则上从任何一个都可以)，依次穿线，穿过其余3个正方形的中心。</p>
<p><img src="/images/geo/56_20_1%E9%98%B6%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF.gif" alt="希尔伯特曲线1阶"></p>
<p>二阶的希尔伯特曲线，生成方法就是把之前每个子正方形继续四等分，每4个小的正方形先生成一阶希尔伯特曲线。然后把4个一阶的希尔伯特曲线首尾相连。</p>
<p><img src="/images/geo/56_21_2%E9%98%B6%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF.gif" alt="希尔伯特曲线2阶"></p>
<p>三阶的希尔伯特曲线，生成方法就是与二阶类似，先生成二阶希尔伯特曲线。然后把4个二阶的希尔伯特曲线首尾相连。需要注意的是为了保证连续性，做了旋转操作。</p>
<p><img src="/images/geo/56_22_3%E9%98%B6%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF.gif" alt="希尔伯特曲线3阶"></p>
<p>n阶的希尔伯特曲线的生成方法也是递归的，先生成n-1阶的希尔伯特曲线，然后把4个n-1阶的希尔伯特曲线首尾相连。</p>
<p><img src="/images/geo/56_23_5n%E9%98%B6%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF.gif"></p>
<h3 id="希尔伯特曲线特性"><a href="#希尔伯特曲线特性" class="headerlink" title="希尔伯特曲线特性"></a>希尔伯特曲线特性</h3><h4 id="降维"><a href="#降维" class="headerlink" title="降维"></a>降维</h4><p>作为空间填充曲线，希尔伯特曲线可以对多维空间有效的降维。希尔伯特曲线，本身就是对一条直线不断切分，生成的，从而可以填满2D区间。反过来说，这条曲线本身就是一维的。</p>
<p><img src="/images/geo/56_24_6%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF%E5%B1%95%E5%BC%80%E6%88%90%E7%BA%BF.gif"></p>
<p>上图就是希尔伯特曲线在填满一个平面以后，把平面上的点都展开成一维的线了。</p>
<p>当然，当n趋近于无穷大的时候，n阶希尔伯特曲线就可以近似填满整个平面了。这也是分形的特性，回到前面讲的“无限长的大不列颠岛的海岸线”。这里也是一样的，不但可以填满整个平面，从另外一个角度来说，这个线也是无限长的。当我们说这个长度是多少的时候，其实是有一个n来限制的。</p>
<p><img src="/images/geo/56_25_7%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF%E6%97%A0%E9%99%90%E5%88%92%E5%88%86%E4%B8%8B%E5%8E%BB.gif"></p>
<h4 id="稳定性"><a href="#稳定性" class="headerlink" title="稳定性"></a>稳定性</h4><p>当n阶希尔伯特曲线，n趋于无穷大的时候，曲线上的点的位置基本上趋于稳定。举个例子：</p>
<p><img src="/images/geo/56_26_8%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF%E4%B8%8E%E8%9B%87%E5%BD%A2%E6%9B%B2%E7%BA%BF%E5%93%AA%E4%B8%AA%E5%A5%BD.gif"></p>
<p>上图左边是希尔伯特曲线，右边是蛇形曲线。当n趋于无穷大的时候，两者理论上都可以填满平面。但是希尔伯特曲线更加优秀。</p>
<p>在蛇形曲线上给定一个点，当n趋于无穷大的过程中，这个点在蛇形曲线上的位置是时刻变化的。这就造成了点的相对位置始终不定。</p>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><img src="/images/geo/56_27_9%E8%9B%87%E5%BD%A2%E6%9B%B2%E7%BA%BF%E6%9D%A5%E5%9B%9E%E6%91%86%E5%8A%A8.gif"></td>
</tr>
<tr>
<td><img src="/images/geo/56_28_10%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF%E8%B6%8B%E8%BF%91%E7%A8%B3%E5%AE%9A.gif"></td>
</tr>
</tbody></table>
<p>再看看希尔伯特曲线，同样是一个点，在n趋于无穷大的情况下：</p>
<p>从上图可以看到，点的位置几乎没有怎么变化。所以希尔伯特曲线更加优秀。</p>
<h4 id="连续性"><a href="#连续性" class="headerlink" title="连续性"></a>连续性</h4><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><img src="/images/geo/%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF-%E8%BF%9E%E7%BB%AD_0.png"></td>
<td><img src="/images/geo/%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF-%E8%BF%9E%E7%BB%AD_1.png"></td>
</tr>
</tbody></table>
<p>希尔伯特曲线是连续的，所以能保证一定可以填满空间。连续性是需要数学证明的。具体证明方法这里就不细说了。</p>
<p>参考文档：</p>
<p><a target="_blank" rel="noopener" href="http://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/?utm_source=tuicool">http://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/?utm_source=tuicool</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/35358486">https://zhuanlan.zhihu.com/p/35358486</a><br><a target="_blank" rel="noopener" href="https://halfrost.com/go_spatial_search/">https://halfrost.com/go_spatial_search/</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Space-filling_curve">Space-filling curve</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/List_of_fractals_by_Hausdorff_dimension">List of fractals by Hausdorff dimension</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=3s7h2MHQtxc">介绍希尔伯特曲线的Youtube视频</a><br><a target="_blank" rel="noopener" href="http://bit-player.org/extras/hilbert/hilbert-mapping.html">希尔伯特曲线在线演示</a><br><a target="_blank" rel="noopener" href="http://www4.ncsu.edu/~njrose/pdfFiles/HilbertCurve.pdf">希尔伯特曲线论文</a><br><a target="_blank" rel="noopener" href="http://bit-player.org/2013/mapping-the-hilbert-curve">Mapping the Hilbert curve</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=ay8OMOsf6AQ">伯努瓦.曼德勃罗:分形和粗糙的艺术<br>https://www.bilibili.com/video/av3602681/</a></p>
<p><img src="https://pic1.zhimg.com/80/v2-c3842f9c8258b3fc20684770b05f85ac_hd.jpg" alt="Hilbert曲线"><br><img src="https://pic3.zhimg.com/80/v2-56f5284dad1dbd5818ab4717dbd1c84a_hd.jpg" alt="Dragon曲线"><br><img src="https://pic1.zhimg.com/80/v2-9b41e04ed570992a3e96a9fac08d1ba4_hd.jpg" alt="Gospher曲线"><br><img src="https://pic4.zhimg.com/80/v2-dc011037f5125038a1082de41568edcf_hd.jpg" alt="img"><br><img src="https://pic1.zhimg.com/80/v2-e6f2a5c9d9c3b348efdb536a89d6ce48_hd.jpg" alt="img"><br><img src="https://pic2.zhimg.com/80/v2-55f2c597fb6b163d00495bf83408d4e5_hd.jpg" alt="img"><br><img src="/images/geo/curve_3.png" alt="摩尔曲线"></p>
<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.shenyanchao.cn/blog/2020/01/16/geo_spatial_search_overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shenyanchao.jpeg">
      <meta itemprop="name" content="申艳超">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="申艳超-博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 申艳超-博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2020/01/16/geo_spatial_search_overview/" class="post-title-link" itemprop="url">空间搜索概述</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-16 22:03:21" itemprop="dateCreated datePublished" datetime="2020-01-16T22:03:21+08:00">2020-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-09 11:44:54" itemprop="dateModified" datetime="2022-11-09T11:44:54+08:00">2022-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/geo/" itemprop="url" rel="index"><span itemprop="name">geo</span></a>
        </span>
    </span>

  
    <span id="/blog/2020/01/16/geo_spatial_search_overview/" class="post-meta-item leancloud_visitors" data-flag-title="空间搜索概述" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="空间搜索综述"><a href="#空间搜索综述" class="headerlink" title="空间搜索综述"></a>空间搜索综述</h2><p>空间搜索是针对多维空间数据进行的搜索，这听起来是一句废话。但是，这重点强调的是<strong>空间</strong>数据，而且数据是**多维(2D, 3D, …)**的。同时, 空间搜索有别于传统的网页文本搜索(google, baidu等)，传统搜索引擎针对的是海量的文本，分词之后，通过倒排等技术来进行快速的匹配。</p>
<p>空间搜索的数据则是点、线、多边形，多维空间等等几何体。如何能高效准确的搜索出想要的空间数据是空间搜索需要解决的。</p>
<h3 id="在生活中无处不在"><a href="#在生活中无处不在" class="headerlink" title="在生活中无处不在"></a>在生活中无处不在</h3><p>无形之中，空间搜索已经存在于我们生活中的方方面面。也许，出门你可能要打个车，看看附近有哪些司机师傅可以接单。自驾要搜索一下沿途的加油站，如果是电车你可能想找一下充电桩。抑或是你今天休息宅在家里，想找个餐厅，定个外卖。所有的这些都离不开空间搜索支持。</p>
<p><img src="/images/geo_spatial_search_overview/geo_in_life.jpeg" alt="空间搜索无处不在"></p>
<p>现在比较流行的RDBMS数据库 MySQL、PostgreSQL 都原生支持 B+ 树。这种数据结构能高效的查询。MongoDB、Redis等NoSQL数据库原生的支持了空间索引能力。业界对于空间搜索的需求是巨大的。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2020/01/16/geo_spatial_search_overview/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.shenyanchao.cn/blog/2020/01/16/geo_uber_h3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shenyanchao.jpeg">
      <meta itemprop="name" content="申艳超">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="申艳超-博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 申艳超-博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2020/01/16/geo_uber_h3/" class="post-title-link" itemprop="url">Uber-H3索引系统</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-01-16 22:03:21" itemprop="dateCreated datePublished" datetime="2020-01-16T22:03:21+08:00">2020-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-09 11:50:06" itemprop="dateModified" datetime="2022-11-09T11:50:06+08:00">2022-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/geo/" itemprop="url" rel="index"><span itemprop="name">geo</span></a>
        </span>
    </span>

  
    <span id="/blog/2020/01/16/geo_uber_h3/" class="post-meta-item leancloud_visitors" data-flag-title="Uber-H3索引系统" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="/images/geo-uber-h3/h3_level_0.jpeg" alt="h3_level_0"></p>
<p>Uber H3是Uber实现的一个基于正六边形，分层空间索引系统。</p>
<p>H3：</p>
<ul>
<li>功能-世界分割成正六边形的网格</li>
<li>本质是一个分层网格系统</li>
<li>支持全球，把世界划分为平米级的网格</li>
</ul>
<h3 id="使用正二十面体投影"><a href="#使用正二十面体投影" class="headerlink" title="使用正二十面体投影"></a>使用正二十面体投影</h3><p>h3选择以正二十面体做为投影，通过把地球坐标映射到正二十面体的20个面上，然后再针对每个面做进一步的切分。正二十面体如下图所示：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><img src="/images/geo-uber-h3/678px-Icosahedron-golden-rectangles.svg.png" alt="正二十面体"></td>
<td><img src="/images/geo-uber-h3/google_h3_20.png" alt="google_h3_20"></td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2020/01/16/geo_uber_h3/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.shenyanchao.cn/blog/2019/12/17/uber-h3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shenyanchao.jpeg">
      <meta itemprop="name" content="申艳超">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="申艳超-博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 申艳超-博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2019/12/17/uber-h3/" class="post-title-link" itemprop="url">H3:Uber的六边型层次空间索引</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-12-17 20:02:15" itemprop="dateCreated datePublished" datetime="2019-12-17T20:02:15+08:00">2019-12-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-01-09 12:08:23" itemprop="dateModified" datetime="2020-01-09T12:08:23+08:00">2020-01-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/geo/" itemprop="url" rel="index"><span itemprop="name">geo</span></a>
        </span>
    </span>

  
    <span id="/blog/2019/12/17/uber-h3/" class="post-meta-item leancloud_visitors" data-flag-title="H3:Uber的六边型层次空间索引" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="/images/uber-h3/Twitter-H3.png" alt="Uber H3">网格系统(Grid System)对于分析海量空间数据集，将地球空间划分为可识别的网格单元(cell)至关重要。</p>
<p>考虑到这一点，Uber开发了 <a target="_blank" rel="noopener" href="https://github.com/uber/h3">H3</a> ，这是我们的网格系统，它可以用来有效优化乘车价格和调度、地图空间数据的可视化和挖掘。 H3使我们能够分析地理信息以设置动态价格并在整个城市范围内做出决策。 我们将H3作为网格系统用于整个市场的分析和优化。 H3就是为此目的而设计的，它使我们可以使用六边形层次索引。</p>
<p>今年早些时候，我们在Github上 <a target="_blank" rel="noopener" href="https://github.com/uber/h3">开源了H3</a> ，大家都可以使用此强大的解决方案，上周，我们开源了 <a target="_blank" rel="noopener" href="https://github.com/uber/h3-js">H3 JavaScript</a> 版本。 在本文中，我们讨论了为什么我们使用网格系统，H3的某些独特属性以及如何开始使用H3。</p>
<p><img src="/images/uber-h3/image12.png" alt="h3, 六边形"><br><em>图1. H3把地球分成很多六边形，使用户可以进行更精准的分析。</em></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2019/12/17/uber-h3/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2012 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">申艳超</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"vFAoofuVWgdHsCv6B6BtqROc-gzGzoHsz","app_key":"ANWUkmboGiNDNRmf2iVlUIGt","server_url":null,"security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>



</body>
</html>
